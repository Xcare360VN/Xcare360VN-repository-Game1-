<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Có Bao Nhiêu Người Giống Bạn?</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "htm": "https://esm.sh/htm@3.1.1"
        }
      }
    </script>
    <style>
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      }
      /* Add a fade-in animation */
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
       @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
            max-height: 0;
        }
        to {
            opacity: 1;
            transform: translateY(0);
            max-height: 500px; /* Adjust as needed */
        }
      }
      .animate-fade-in {
        animation: fadeIn 0.5s ease-out forwards;
      }
      .animate-slide-down {
        animation: slideDown 0.5s ease-out forwards;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div id="root">
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #0c1427; color: #94a3b8; font-size: 1.25rem;">
          Đang tải ứng dụng...
        </div>
    </div>
    <script type="module">
      import React, { useState, useEffect, useCallback, Fragment } from 'react';
      import ReactDOM from 'react-dom/client';
      import htm from 'htm';

      const html = htm.bind(React.createElement);

      // --- HELPERS ---
      const normalizeUrl = (url) => {
        if (typeof url !== 'string' || url.trim() === '' || url.trim() === '#') {
            return '#';
        }
        let trimmedUrl = url.trim();
        if (!/^(https?:\/\/|mailto:|tel:)/i.test(trimmedUrl)) {
            return `https://${trimmedUrl}`;
        }
        return trimmedUrl;
      };
      const convertGoogleDriveUrl = (url) => {
          if (typeof url !== 'string' || !url.includes('drive.google.com')) {
              return url;
          }
          const match = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
          if (match && match[1]) {
              const fileId = match[1];
              return `https://lh3.googleusercontent.com/d/${fileId}`;
          }
          return url;
      };
      const shuffleArray = (array) => {
          return array.map(value => ({ value, sort: Math.random() }))
            .sort((a, b) => a.sort - b.sort)
            .map(({ value }) => value);
      };

      // --- STORAGE SERVICE ---
      const getAnsweredQuestionIds = () => {
        try {
            const storedIds = localStorage.getItem('answeredQuestions');
            return storedIds ? JSON.parse(storedIds) : [];
        } catch (error) {
            console.error('Không thể đọc ID câu hỏi đã trả lời từ localStorage:', error);
            return [];
        }
      };
      const addAnsweredQuestionId = (questionId) => {
          try {
              const answeredIds = getAnsweredQuestionIds();
              if (!answeredIds.includes(questionId)) {
                  answeredIds.push(questionId);
                  localStorage.setItem('answeredQuestions', JSON.stringify(answeredIds));
              }
          } catch (error) {
              console.error('Không thể lưu ID câu hỏi đã trả lời vào localStorage:', error);
          }
      };
      const clearAnsweredQuestions = () => {
        try {
            localStorage.removeItem('answeredQuestions');
        } catch (error) {
            console.error('Không thể xóa tiến trình đã lưu:', error);
        }
      };

      // --- MOCK DATA ---
      const getDaysAgo = (days) => new Date(Date.now() - days * 24 * 60 * 60 * 1000).toISOString();
      const MY_LIST = [
        { id: 'A01PET', name: 'Thú cưng & Động vật', description: 'Khám phá suy nghĩ và cảm xúc của bạn về những người bạn lông lá, có cánh và có vảy của chúng ta. Bạn nghĩ gì về thế giới động vật?' },
        { id: 'B01All', name: 'Trí tuệ nhân tạo', description: 'Hòa mình vào thế giới của AI. Bạn hào hứng hay lo lắng về tương lai của những cỗ máy thông minh? Hãy cùng tìm hiểu xem những người khác nghĩ gì.' }
      ];
      const MY_INFO = [
        { name: 'Công ty Công nghệ Tuyệt vời', logoUrl: 'https://picsum.photos/seed/tech/100/100', websiteUrl: '#', isActive: true, content: 'Chúng tôi tự hào đồng hành cùng bạn trong hành trình khám phá bản thân. Công nghệ là để kết nối, và chúng tôi tin rằng việc hiểu rõ hơn về chính mình và cộng đồng là bước đầu tiên.' },
        { name: 'Thiên đường Thú cưng', logoUrl: 'https://picsum.photos/seed/pet/100/100', websiteUrl: '#', isActive: false, content: 'Mỗi thú cưng là một người bạn. Hãy yêu thương và chăm sóc chúng nhé!' }
      ];
      const MOCK_ALL_QUESTIONS = [
        { id: 'P01', text: 'Bạn có tin rằng chó thực sự là "bạn thân nhất của con người" không?', options: ['Có', 'Không'], stats: { 'Có': 1843, 'Không': 211 }, dateAdded: getDaysAgo(30), originalTopicId: 'A01PET' },
        { id: 'P02', text: 'Bạn thích nuôi mèo hơn nuôi chó?', options: ['Có', 'Không'], stats: { 'Có': 987, 'Không': 1067 }, dateAdded: getDaysAgo(25), originalTopicId: 'A01PET' },
        { id: 'P03', text: 'Có nên nuôi động vật hoang dã làm thú cưng không?', options: ['Có', 'Không'], stats: { 'Có': 345, 'Không': 1709 }, dateAdded: getDaysAgo(2), originalTopicId: 'A01PET' },
        { id: 'P04', text: 'Bạn sẽ chọn nuôi con vật nào?', options: ['Cá', 'Chim', 'Chuột Hamster', 'Rắn'], stats: { 'Cá': 890, 'Chim': 654, 'Chuột Hamster': 432, 'Rắn': 123 }, dateAdded: getDaysAgo(40), originalTopicId: 'A01PET' },
        { id: 'AI01', text: 'Bạn có lo lắng một ngày nào đó AI sẽ chiếm lấy công việc của bạn không?', options: ['Có', 'Không'], stats: { 'Có': 1302, 'Không': 742 }, dateAdded: getDaysAgo(15), originalTopicId: 'B01All' },
        { id: 'AI02', text: 'Bạn có nghĩ rằng AI cuối cùng sẽ trở nên thông minh hơn con người không?', options: ['Có', 'Không'], stats: { 'Có': 1655, 'Không': 389 }, dateAdded: getDaysAgo(12), originalTopicId: 'B01All' },
        { id: 'AI03', text: 'Bạn có tin tưởng để một AI phẫu thuật cho mình không?', options: ['Có', 'Không'], stats: { 'Có': 210, 'Không': 1834 }, dateAdded: getDaysAgo(5), originalTopicId: 'B01All' },
        { id: 'AI04', text: 'Đối với bạn, ứng dụng nào của AI là thú vị nhất?', options: ['Chăm sóc sức khỏe', 'Giao thông vận tải', 'Giải trí', 'Khoa học'], stats: { 'Chăm sóc sức khỏe': 788, 'Giao thông vận tải': 450, 'Giải trí': 312, 'Khoa học': 505 }, dateAdded: getDaysAgo(20), originalTopicId: 'B01All' }
      ];

      // --- GAME SERVICE ---
      const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbykpc4zubNxgaHYtDxkzpt4vmj9wuEKSbPMulbVahByUC_70Pe7st1n5MBAMuBn6_Y9kg/exec';
      async function fetchFromApi(action, params = {}) {
        const urlParams = new URLSearchParams({ action, ...params });
        urlParams.set('v', new Date().getTime().toString());
        const url = `${GOOGLE_SHEET_URL}?${urlParams.toString()}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Server responded with status ${response.status}`);
        const jsonResponse = await response.json();
        const data = jsonResponse.data || jsonResponse;
        if (typeof data === 'object' && data !== null && data.status === 'error' && data.message) {
          throw new Error(`Apps Script error for action '${action}': ${data.message}`);
        }
        return data;
      }
       async function getInitialData() {
          try {
              const rawData = await fetchFromApi('getAllData');
              
              if (!rawData || !Array.isArray(rawData.topics) || !Array.isArray(rawData.sponsors) || !Array.isArray(rawData.allQuestions)) {
                  throw new Error("Dữ liệu nhận được từ API không hợp lệ.");
              }

              const sponsors = rawData.sponsors.map(item => ({ ...item, isActive: String(item.isActive).toUpperCase() === 'TRUE' }));
              
              const allQuestions = rawData.allQuestions.map(q => {
                  const options = [];
                  if (q.opt1 && q.opt1 !== 'N/A') options.push(q.opt1);
                  if (q.opt2 && q.opt2 !== 'N/A') options.push(q.opt2);
                  if (q.opt3 && q.opt3 !== 'N/A') options.push(q.opt3);
                  if (q.opt4 && q.opt4 !== 'N/A') options.push(q.opt4);
                  
                  let stats = {};
                  try {
                      stats = typeof q.stats === 'string' ? JSON.parse(q.stats) : (q.stats || {});
                  } catch (e) {
                      console.error(`Không thể phân tích stats cho câu hỏi ID ${q.id}:`, q.stats);
                  }

                  return { id: q.id, text: q.question, options, stats, dateAdded: q.dateAdded, originalTopicId: q.originalTopicId };
              });
              
              return { topics: rawData.topics, sponsors, allQuestions };
          } catch (error) {
              console.warn(`Không thể tải dữ liệu ban đầu. Sử dụng dữ liệu dự phòng. Lỗi:`, error);
              return {
                  topics: MY_LIST,
                  sponsors: MY_INFO,
                  allQuestions: MOCK_ALL_QUESTIONS
              };
          }
      }
      async function submitAnswer(topicId, questionId, selectedOption) {
        const params = { topicId, questionId, selectedOption };
        try {
          await fetchFromApi('submit', params);
          console.log(`Đã gửi thành công câu trả lời cho ${questionId}: ${selectedOption}`);
        } catch (error) {
          console.error('Lỗi mạng khi gửi câu trả lời:', error);
        }
      }
     
      // --- ICONS ---
      const ShuffleIcon = ({ className = 'w-6 h-6' }) => html`<svg xmlns="http://www.w3.org/2000/svg" class=${className} fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6m13-14v4m-4-4l4 4m-4 11v4m-4-4l4 4" /></svg>`;
      const ShareIcon = ({ className = 'w-6 h-6' }) => html`<svg xmlns="http://www.w3.org/2000/svg" class=${className} fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6.002l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.367a3 3 0 105.367 2.684 3 3 0 00-5.367 2.684z" /></svg>`;
      const TrophyIcon = ({ className = 'w-6 h-6' }) => html`<svg xmlns="http://www.w3.org/2000/svg" class=${className} fill="currentColor" viewBox="0 0 16 16"><path d="m8 0l1.669.864 1.858.282.842 1.68 1.337 1.32L13.4 6l.306 1.854-1.337 1.32-.842 1.68-1.858.282L8 12l-1.669-.864-1.858-.282-.842-1.68-1.337-1.32L2.6 6l-.306-1.854 1.337 1.32.842-1.68L6.331.864z"/><path d="M4 11.794V16l4-1 4 1v-4.206l-2.018.306L8 13.126 6.018 12.1z"/></svg>`;
      const CheckCircleIcon = ({ className = 'w-6 h-6' }) => html`<svg xmlns="http://www.w3.org/2000/svg" class=${className} viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;
      const TrashIcon = ({ className = 'w-6 h-6' }) => html`<svg xmlns="http://www.w3.org/2000/svg" class=${className} viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>`;
      const ChevronDownIcon = ({ className = 'w-6 h-6' }) => html`<svg xmlns="http://www.w3.org/2000/svg" class=${className} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>`;

      // --- COMPONENTS ---
      const SponsorBanner = ({ sponsors }) => {
          const activeSponsor = sponsors.find(s => s.isActive);
          if (!activeSponsor) return null;
          const { name, logoUrl, websiteUrl, content } = activeSponsor;
          const safeLogoUrl = convertGoogleDriveUrl(logoUrl);
          const safeWebsiteUrl = normalizeUrl(websiteUrl);

          return html`
              <div class="bg-gray-800 bg-opacity-50 rounded-lg p-4 text-center mt-8 animate-fade-in mx-4">
                  <h3 class="text-sm font-semibold text-gray-400 mb-3">Nhà tài trợ</h3>
                  <div class="flex items-center justify-center space-x-4">
                      <img src=${safeLogoUrl} alt=${`Logo ${name}`} class="w-16 h-16 rounded-full object-cover border-2 border-gray-600" />
                      <div>
                          <h4 class="font-bold text-white">${name}</h4>
                          <p class="text-sm text-gray-300 mt-1">${content}</p>
                          ${websiteUrl && websiteUrl !== '#' && html`
                              <a href=${safeWebsiteUrl} target="_blank" rel="noopener noreferrer" class="text-sm text-cyan-400 hover:text-cyan-300 transition-colors duration-200 mt-2 inline-block">
                                  Tìm hiểu thêm
                              </a>
                          `}
                      </div>
                  </div>
              </div>
          `;
      };

      const ResultsCard = ({ question, selectedOption, onNext, onShare }) => {
          const totalVotes = Object.values(question.stats).reduce((sum, count) => (sum || 0) + (count || 0), 0);
          const selectedOptionVotes = question.stats[selectedOption] || 0;
          const percentage = totalVotes > 0 ? Math.round((selectedOptionVotes / totalVotes) * 100) : 0;

          return html`
              <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md mx-auto animate-fade-in">
                  <h2 class="text-lg font-bold text-white mb-2">${question.text}</h2>
                  <p class="text-gray-400 mb-6">Bạn đã chọn: <span class="font-semibold text-cyan-400">${selectedOption}</span></p>

                  <div class="bg-gray-700 rounded-lg p-4 mb-6">
                      <div class="flex justify-between items-center mb-2">
                          <span class="font-bold text-4xl text-cyan-300">${percentage}%</span>
                          <span class="text-gray-300">người đã chọn giống bạn</span>
                      </div>
                      <div class="w-full bg-gray-600 rounded-full h-2.5">
                          <div class="bg-cyan-400 h-2.5 rounded-full" style=${{ width: `${percentage}%` }}></div>
                      </div>
                      <p class="text-xs text-gray-400 mt-2 text-right">${selectedOptionVotes.toLocaleString('vi-VN')} / ${totalVotes.toLocaleString('vi-VN')} lượt vote</p>
                  </div>
                  
                  <div class="space-y-4">
                      ${question.options.map(option => {
                          const votes = question.stats[option] || 0;
                          const optionPercentage = totalVotes > 0 ? Math.round((votes / totalVotes) * 100) : 0;
                          const isSelected = option === selectedOption;
                          return html`
                              <div key=${option} class="relative overflow-hidden rounded-md p-3 ${isSelected ? 'bg-cyan-900/50 ring-2 ring-cyan-400' : 'bg-gray-700'}">
                                  <div class="absolute top-0 left-0 h-full ${isSelected ? 'bg-cyan-500/30' : 'bg-gray-500/30'}" style=${{ width: `${optionPercentage}%` }}></div>
                                  <div class="relative flex justify-between items-center z-10">
                                      <span class="font-medium ${isSelected ? 'text-white' : 'text-gray-300'}">${option}</span>
                                      <span class="font-semibold ${isSelected ? 'text-cyan-300' : 'text-gray-400'}">${optionPercentage}%</span>
                                  </div>
                              </div>
                          `;
                      })}
                  </div>
                  
                  <div class="mt-8 flex gap-4">
                      <button onClick=${onShare} class="w-1/3 bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center transition-colors duration-200" aria-label="Chia sẻ kết quả">
                          <${ShareIcon} className="w-5 h-5" />
                      </button>
                      <button onClick=${onNext} class="w-2/3 bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200">
                          Câu hỏi tiếp theo
                      </button>
                  </div>
              </div>
          `;
      };

      const QuestionCard = ({ question, onAnswer, questionNumber, totalQuestions }) => {
          return html`
              <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md mx-auto animate-fade-in">
                  <div class="text-right text-gray-400 text-sm mb-4">Câu ${questionNumber} / ${totalQuestions}</div>
                  <h2 class="text-xl font-bold text-white mb-6 text-center">${question.text}</h2>
                  <div class="space-y-3">
                      ${question.options.map(option => html`
                          <button 
                              key=${option}
                              onClick=${() => onAnswer(option)}
                              class="w-full text-left bg-gray-700 hover:bg-cyan-900/50 hover:ring-2 hover:ring-cyan-500 text-white font-medium py-3 px-5 rounded-lg transition-all duration-200"
                          >
                              ${option}
                          </button>
                      `)}
                  </div>
              </div>
          `;
      };

      const GameSummaryCard = ({ topic, onBack }) => {
          return html`
              <div class="bg-gray-800 rounded-lg p-8 w-full max-w-md mx-auto text-center animate-fade-in">
                  <div class="flex justify-center mb-4">
                      <div class="bg-green-500/20 p-3 rounded-full">
                          <${TrophyIcon} className="w-12 h-12 text-green-400" />
                      </div>
                  </div>
                  <h2 class="text-2xl font-bold text-white mb-2">Chúc mừng!</h2>
                  <p class="text-gray-300 mb-1">Bạn đã hoàn thành chủ đề:</p>
                  <p class="text-xl font-semibold text-cyan-400 mb-6">${topic.name}</p>
                  <p class="text-gray-400 mb-8">Hãy thử một chủ đề khác hoặc chơi chế độ ngẫu nhiên để khám phá thêm nhé!</p>
                  <button onClick=${onBack} class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200">
                      Quay về trang chủ
                  </button>
              </div>
          `;
      };

      const TopicSelection = ({ topics, onSelectTopic, allQuestions, onResetProgress }) => {
          const [answeredIds, setAnsweredIds] = useState(getAnsweredQuestionIds());
          const [showCompleted, setShowCompleted] = useState(false);

          const topicProgress = topics.map(topic => {
              const topicQuestions = allQuestions.filter(q => q.originalTopicId === topic.id);
              const answeredInTopic = topicQuestions.filter(q => answeredIds.includes(q.id));
              const isCompleted = topicQuestions.length > 0 && topicQuestions.length === answeredInTopic.length;
              return { ...topic, isCompleted, totalQuestions: topicQuestions.length, answeredCount: answeredInTopic.length };
          });

          const uncompletedTopics = topicProgress.filter(t => !t.isCompleted);
          const completedTopics = topicProgress.filter(t => t.isCompleted);

          const handleReset = () => {
            if (window.confirm('Bạn có chắc muốn xóa toàn bộ tiến trình đã lưu và bắt đầu lại không?')) {
              onResetProgress();
              setAnsweredIds([]);
            }
          };

          return html`
              <div class="p-4 md:p-6 w-full max-w-2xl mx-auto animate-fade-in">
                  <header class="text-center mb-8">
                      <h1 class="text-4xl font-extrabold text-white">Có Bao Nhiêu Người</h1>
                      <h1 class="text-4xl font-extrabold text-cyan-400 mb-2">Giống Bạn?</h1>
                      <p class="text-gray-400">Bạn đang ở nhóm nào?</p>
                  </header>
                  
                  <div class="bg-gray-800/60 backdrop-blur-sm rounded-lg p-6 mb-6">
                      <h2 class="text-xl font-bold text-white mb-4">Chọn chế độ chơi</h2>
                      <div 
                          class="flex items-center space-x-4 p-4 rounded-lg cursor-pointer transition-all duration-200 bg-gray-700/50 hover:bg-cyan-900/50 hover:ring-2 hover:ring-cyan-500"
                          onClick=${() => onSelectTopic('random')}
                      >
                          <div class="bg-cyan-500 p-3 rounded-lg">
                              <${ShuffleIcon} className="w-6 h-6 text-white" />
                          </div>
                          <div>
                              <h3 class="font-bold text-white">Ngẫu nhiên</h3>
                              <p class="text-sm text-gray-300">Các câu hỏi được trộn từ tất cả các chủ đề.</p>
                          </div>
                      </div>
                  </div>

                  <div class="bg-gray-800/60 backdrop-blur-sm rounded-lg p-6">
                      <h2 class="text-xl font-bold text-white mb-4">Hoặc chọn một chủ đề</h2>
                      <div class="space-y-3">
                          ${uncompletedTopics.map(topic => html`
                              <div 
                                  key=${topic.id}
                                  class="p-4 rounded-lg cursor-pointer transition-all duration-200 bg-gray-700/50 hover:bg-gray-700"
                                  onClick=${() => onSelectTopic(topic.id)}
                              >
                                  <div class="flex justify-between items-center">
                                    <h3 class="font-bold text-cyan-400">${topic.name}</h3>
                                    ${topic.answeredCount > 0 && html`
                                      <span class="text-xs font-medium text-gray-400 bg-gray-600 px-2 py-1 rounded-full">${topic.answeredCount}/${topic.totalQuestions}</span>
                                    `}
                                  </div>
                                  <p class="text-sm text-gray-300 mt-1">${topic.description}</p>
                              </div>
                          `)}
                      </div>
                      ${completedTopics.length > 0 && html`
                          <div class="mt-6">
                              <button 
                                  class="w-full flex justify-between items-center p-3 rounded-md text-left text-gray-300 hover:bg-gray-700/50"
                                  onClick=${() => setShowCompleted(!showCompleted)}
                                  aria-expanded=${showCompleted}
                              >
                                  <span class="font-semibold">Chủ đề đã hoàn thành (${completedTopics.length})</span>
                                  <${ChevronDownIcon} className=${`w-5 h-5 transition-transform duration-300 ${showCompleted ? 'rotate-180' : ''}`} />
                              </button>
                              ${showCompleted && html`
                                  <div class="mt-2 space-y-2 animate-slide-down">
                                      ${completedTopics.map(topic => html`
                                          <div key=${topic.id} class="flex items-center space-x-3 p-3 rounded-md bg-gray-700/40">
                                              <${CheckCircleIcon} className="w-5 h-5 text-green-400 flex-shrink-0" />
                                              <span class="text-gray-400">${topic.name}</span>
                                          </div>
                                      `)}
                                  </div>
                              `}
                          </div>
                      `}
                  </div>
                  ${answeredIds.length > 0 && html`
                    <div class="text-center mt-8">
                      <button onClick=${handleReset} class="text-gray-500 hover:text-gray-300 text-sm flex items-center gap-2 mx-auto transition-colors">
                        <${TrashIcon} className="w-4 h-4"/>
                        Xóa tiến trình
                      </button>
                    </div>
                  `}
              </div>
          `;
      };

      // --- MAIN APP ---
      const App = () => {
          const [gameState, setGameState] = useState({
              screen: 'loading', // loading, topicSelection, playing, results, summary
              topics: [],
              sponsors: [],
              allQuestions: [],
              currentTopicId: null,
              currentQuestionIndex: -1,
              questionQueue: [],
              lastAnswer: null,
          });
          const [error, setError] = useState(null);

          useEffect(() => {
              const loadData = async () => {
                  try {
                      const { topics, sponsors, allQuestions } = await getInitialData();
                      setGameState(prev => ({ ...prev, topics, sponsors, allQuestions, screen: 'topicSelection' }));
                  } catch (e) {
                      console.error("Lỗi nghiêm trọng khi tải dữ liệu:", e);
                      setError('Không thể tải dữ liệu trò chơi. Vui lòng thử lại sau.');
                      setGameState(prev => ({ ...prev, screen: 'error' }));
                  }
              };
              loadData();
          }, []);

          const startQuiz = (topicId) => {
              const answeredIds = getAnsweredQuestionIds();
              let questionsForTopic;

              if (topicId === 'random') {
                  questionsForTopic = gameState.allQuestions.filter(q => !answeredIds.includes(q.id));
                  if (questionsForTopic.length === 0) { // All questions answered, reset random
                      questionsForTopic = gameState.allQuestions;
                  }
                  questionsForTopic = shuffleArray(questionsForTopic);
              } else {
                  questionsForTopic = gameState.allQuestions.filter(q => q.originalTopicId === topicId);
                  questionsForTopic = questionsForTopic.filter(q => !answeredIds.includes(q.id));
              }

              if (questionsForTopic.length === 0) {
                  alert('Bạn đã hoàn thành tất cả câu hỏi trong chủ đề này!');
                  return;
              }

              setGameState(prev => ({
                  ...prev,
                  screen: 'playing',
                  currentTopicId: topicId,
                  questionQueue: questionsForTopic,
                  currentQuestionIndex: 0,
                  lastAnswer: null,
              }));
          };
          
          const handleAnswer = (selectedOption) => {
              const currentQuestion = gameState.questionQueue[gameState.currentQuestionIndex];
              
              const updatedStats = { ...currentQuestion.stats };
              updatedStats[selectedOption] = (updatedStats[selectedOption] || 0) + 1;
              
              const updatedAllQuestions = gameState.allQuestions.map(q => 
                  q.id === currentQuestion.id ? { ...q, stats: updatedStats } : q
              );
              
              setGameState(prev => ({
                  ...prev,
                  screen: 'results',
                  lastAnswer: selectedOption,
                  allQuestions: updatedAllQuestions,
              }));
              
              addAnsweredQuestionId(currentQuestion.id);
              submitAnswer(currentQuestion.originalTopicId, currentQuestion.id, selectedOption);
          };

          const handleNextQuestion = () => {
              const nextIndex = gameState.currentQuestionIndex + 1;
              if (nextIndex < gameState.questionQueue.length) {
                  setGameState(prev => ({
                      ...prev,
                      screen: 'playing',
                      currentQuestionIndex: nextIndex,
                      lastAnswer: null,
                  }));
              } else {
                  if (gameState.currentTopicId !== 'random') {
                      setGameState(prev => ({ ...prev, screen: 'summary' }));
                  } else {
                       setGameState(prev => ({ ...prev, screen: 'topicSelection' }));
                  }
              }
          };
          
          const handleShare = async () => {
              const currentQuestion = gameState.questionQueue[gameState.currentQuestionIndex];
              const selectedOption = gameState.lastAnswer;
              const totalVotes = Object.values(currentQuestion.stats).reduce((sum, count) => (sum || 0) + (count || 0), 0);
              const selectedOptionVotes = currentQuestion.stats[selectedOption] || 0;
              const percentage = totalVotes > 0 ? Math.round((selectedOptionVotes / totalVotes) * 100) : 0;

              const shareText = `Tôi đã trả lời "${currentQuestion.text}" và ${percentage}% người cũng nghĩ giống tôi! Bạn thì sao?`;
              const shareUrl = window.location.href; 
              
              try {
                  if (navigator.share) {
                      await navigator.share({
                          title: 'Có Bao Nhiêu Người Giống Bạn?',
                          text: shareText,
                          url: shareUrl,
                      });
                  } else {
                      await navigator.clipboard.writeText(`${shareText} ${shareUrl}`);
                      alert('Đã sao chép kết quả vào clipboard!');
                  }
              } catch (err) {
                  console.error('Lỗi khi chia sẻ:', err);
                  alert('Không thể chia sẻ vào lúc này.');
              }
          };
          
          const resetToTopics = () => {
              setGameState(prev => ({
                  ...prev,
                  screen: 'topicSelection',
                  currentTopicId: null,
                  currentQuestionIndex: -1,
                  questionQueue: [],
                  lastAnswer: null,
              }));
          };
          
          const handleResetProgress = () => {
              clearAnsweredQuestions();
              setGameState(prev => ({ ...prev })); 
          };

          const renderScreen = () => {
              const { screen, topics, sponsors, allQuestions, questionQueue, currentQuestionIndex, lastAnswer, currentTopicId } = gameState;
              
              switch (screen) {
                  case 'loading':
                      return html`<div class="flex justify-center items-center h-screen text-lg text-gray-400">Đang tải trò chơi...</div>`;
                  case 'error':
                       return html`<div class="flex justify-center items-center h-screen text-lg text-red-400 p-8 text-center">${error}</div>`;
                  case 'topicSelection':
                      return html`<${TopicSelection} topics=${topics} allQuestions=${allQuestions} onSelectTopic=${startQuiz} onResetProgress=${handleResetProgress} />`;
                  case 'playing': {
                      const currentQuestion = questionQueue[currentQuestionIndex];
                      return html`<${QuestionCard} 
                                      question=${currentQuestion} 
                                      onAnswer=${handleAnswer}
                                      questionNumber=${currentQuestionIndex + 1}
                                      totalQuestions=${questionQueue.length}
                                  />`;
                  }
                  case 'results': {
                      const currentQuestion = questionQueue[currentQuestionIndex];
                      return html`<${ResultsCard} 
                                      question=${currentQuestion} 
                                      selectedOption=${lastAnswer} 
                                      onNext=${handleNextQuestion} 
                                      onShare=${handleShare}
                                  />`;
                  }
                  case 'summary': {
                      const currentTopic = topics.find(t => t.id === currentTopicId);
                       return html`<${GameSummaryCard} topic=${currentTopic} onBack=${resetToTopics} />`;
                  }
                  default:
                      return html`<div class="text-white">Trạng thái không xác định</div>`;
              }
          };

          return html`
            <div class="bg-[#0c1427] min-h-screen text-gray-200 font-sans bg-gradient-to-br from-[#0c1427] to-[#1e2a4a]">
              <div class="container mx-auto flex flex-col items-center justify-center min-h-screen py-8">
                  <main class="w-full flex-grow flex items-center justify-center">
                      ${renderScreen()}
                  </main>
                  ${(gameState.screen === 'topicSelection' || gameState.screen === 'summary') && html`
                      <footer class="w-full mt-auto pt-8">
                          <${SponsorBanner} sponsors=${gameState.sponsors} />
                      </footer>
                  `}
              </div>
            </div>
          `;
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(html`<${React.StrictMode}><${App} /></${React.StrictMode}>`);
    </script>
  </body>
</html>
