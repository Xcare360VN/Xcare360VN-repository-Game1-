<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Có Bao Nhiêu Người Giống Bạn?</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "htm": "https://esm.sh/htm@3.1.1"
        }
      }
    </script>
    <style>
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      }
      /* Add a fade-in animation */
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
       @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
            max-height: 0;
        }
        to {
            opacity: 1;
            transform: translateY(0);
            max-height: 500px; /* Adjust as needed */
        }
      }
      .animate-fade-in {
        animation: fadeIn 0.5s ease-out forwards;
      }
      .animate-slide-down {
        animation: slideDown 0.5s ease-out forwards;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div id="root">
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #0c1427; color: #94a3b8; font-size: 1.25rem;">
          Đang tải ứng dụng...
        </div>
    </div>
    <script type="module">
      import React, { useState, useEffect, useCallback, Fragment } from 'react';
      import ReactDOM from 'react-dom/client';
      import htm from 'htm';

      const html = htm.bind(React.createElement);

      // --- HELPERS ---
      const normalizeUrl = (url) => {
        if (typeof url !== 'string' || url.trim() === '' || url.trim() === '#') {
            return '#';
        }
        let trimmedUrl = url.trim();
        if (!/^(https?:\/\/|mailto:|tel:)/i.test(trimmedUrl)) {
            return `https://${trimmedUrl}`;
        }
        return trimmedUrl;
      };
      const convertGoogleDriveUrl = (url) => {
          if (typeof url !== 'string' || !url.includes('drive.google.com')) {
              return url;
          }
          const match = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
          if (match && match[1]) {
              const fileId = match[1];
              return `https://lh3.googleusercontent.com/d/${fileId}`;
          }
          return url;
      };
      const shuffleArray = (array) => {
          return array.map(value => ({ value, sort: Math.random() }))
            .sort((a, b) => a.sort - b.sort)
            .map(({ value }) => value);
      };

      // --- STORAGE SERVICE ---
      const getAnsweredQuestions = () => {
        try {
            const storedData = localStorage.getItem('answeredQuestions');
            return storedData ? JSON.parse(storedData) : [];
        } catch (error) {
            console.error('Không thể đọc dữ liệu câu hỏi đã trả lời từ localStorage:', error);
            return [];
        }
      };
      const addAnsweredQuestion = (questionId, selectedOption) => {
          try {
              const answered = getAnsweredQuestions();
              // Remove if already exists to prevent duplicates, then add new one
              const newAnswered = answered.filter(item => item.qId !== questionId);
              newAnswered.push({ qId: questionId, answer: selectedOption });
              localStorage.setItem('answeredQuestions', JSON.stringify(newAnswered));
          } catch (error) {
              console.error('Không thể lưu câu hỏi đã trả lời vào localStorage:', error);
          }
      };
      const clearAnsweredQuestions = () => {
        try {
            localStorage.removeItem('answeredQuestions');
        } catch (error) {
            console.error('Không thể xóa tiến trình đã lưu:', error);
        }
      };


      // --- MOCK DATA ---
      const getDaysAgo = (days) => new Date(Date.now() - days * 24 * 60 * 60 * 1000).toISOString();
      const MY_LIST = [
        { id: 'A01PET', name: 'Thú cưng & Động vật', description: 'Khám phá suy nghĩ và cảm xúc của bạn về những người bạn lông lá, có cánh và có vảy của chúng ta. Bạn nghĩ gì về thế giới động vật?' },
        { id: 'B01All', name: 'Trí tuệ nhân tạo', description: 'Hòa mình vào thế giới của AI. Bạn hào hứng hay lo lắng về tương lai của những cỗ máy thông minh? Hãy cùng tìm hiểu xem những người khác nghĩ gì.' }
      ];
      const MY_INFO = [
        { name: 'Công ty Công nghệ Tuyệt vời', logoUrl: 'https://picsum.photos/seed/tech/100/100', websiteUrl: '#', isActive: true, content: 'Chúng tôi tự hào đồng hành cùng bạn trong hành trình khám phá bản thân. Công nghệ là để kết nối, và chúng tôi tin rằng việc hiểu rõ hơn về chính mình và cộng đồng là bước đầu tiên.' },
        { name: 'Thiên đường Thú cưng', logoUrl: 'https://picsum.photos/seed/pet/100/100', websiteUrl: '#', isActive: false, content: 'Mỗi thú cưng là một người bạn. Hãy yêu thương và chăm sóc chúng nhé!' }
      ];
      const MOCK_ALL_QUESTIONS = [
        { id: 'P01', text: 'Bạn có tin rằng chó thực sự là "bạn thân nhất của con người" không?', options: ['Có', 'Không'], stats: { 'Có': 1843, 'Không': 211 }, dateAdded: getDaysAgo(30), originalTopicId: 'A01PET' },
        { id: 'P02', text: 'Bạn thích nuôi mèo hơn nuôi chó?', options: ['Có', 'Không'], stats: { 'Có': 987, 'Không': 1067 }, dateAdded: getDaysAgo(25), originalTopicId: 'A01PET' },
        { id: 'P03', text: 'Có nên nuôi động vật hoang dã làm thú cưng không?', options: ['Có', 'Không'], stats: { 'Có': 345, 'Không': 1709 }, dateAdded: getDaysAgo(2), originalTopicId: 'A01PET' },
        { id: 'P04', text: 'Bạn sẽ chọn nuôi con vật nào?', options: ['Cá', 'Chim', 'Chuột Hamster', 'Rắn'], stats: { 'Cá': 890, 'Chim': 654, 'Chuột Hamster': 432, 'Rắn': 123 }, dateAdded: getDaysAgo(40), originalTopicId: 'A01PET' },
        { id: 'AI01', text: 'Bạn có lo lắng một ngày nào đó AI sẽ chiếm lấy công việc của bạn không?', options: ['Có', 'Không'], stats: { 'Có': 1302, 'Không': 742 }, dateAdded: getDaysAgo(15), originalTopicId: 'B01All' },
        { id: 'AI02', text: 'Bạn có nghĩ rằng AI cuối cùng sẽ trở nên thông minh hơn con người không?', options: ['Có', 'Không'], stats: { 'Có': 1655, 'Không': 389 }, dateAdded: getDaysAgo(12), originalTopicId: 'B01All' },
        { id: 'AI03', text: 'Bạn có tin tưởng để một AI phẫu thuật cho mình không?', options: ['Có', 'Không'], stats: { 'Có': 210, 'Không': 1834 }, dateAdded: getDaysAgo(5), originalTopicId: 'B01All' },
        { id: 'AI04', text: 'Đối với bạn, ứng dụng nào của AI là thú vị nhất?', options: ['Chăm sóc sức khỏe', 'Giao thông vận tải', 'Giải trí', 'Khoa học'], stats: { 'Chăm sóc sức khỏe': 788, 'Giao thông vận tải': 450, 'Giải trí': 312, 'Khoa học': 505 }, dateAdded: getDaysAgo(20), originalTopicId: 'B01All' }
      ];

      // --- GAME SERVICE ---
      const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbykpc4zubNxgaHYtDxkzpt4vmj9wuEKSbPMulbVahByUC_70Pe7st1n5MBAMuBn6_Y9kg/exec';
      async function fetchFromApi(action, params = {}) {
        const urlParams = new URLSearchParams({ action, ...params });
        urlParams.set('v', new Date().getTime().toString());
        const url = `${GOOGLE_SHEET_URL}?${urlParams.toString()}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Server responded with status ${response.status}`);
        const jsonResponse = await response.json();
        const data = jsonResponse.data || jsonResponse;
        if (typeof data === 'object' && data !== null && data.status === 'error' && data.message) {
          throw new Error(`Apps Script error for action '${action}': ${data.message}`);
        }
        return data;
      }
       async function getInitialData() {
          try {
              const rawData = await fetchFromApi('getAllData');
              
              if (!rawData || !Array.isArray(rawData.topics) || !Array.isArray(rawData.sponsors) || !Array.isArray(rawData.allQuestions)) {
                  throw new Error("Dữ liệu nhận được từ API không hợp lệ.");
              }

              const sponsors = rawData.sponsors.map(item => ({ ...item, isActive: String(item.isActive).toUpperCase() === 'TRUE' }));
              
              const allQuestions = rawData.allQuestions.map(q => {
                  const options = [];
                  if (q.opt1 && q.opt1 !== 'N/A') options.push(q.opt1);
                  if (q.opt2 && q.opt2 !== 'N/A') options.push(q.opt2);
                  if (q.opt3 && q.opt3 !== 'N/A') options.push(q.opt3);
                  if (q.opt4 && q.opt4 !== 'N/A') options.push(q.opt4);
                  
                  let stats = {};
                  try {
                      stats = typeof q.stats === 'string' ? JSON.parse(q.stats) : (q.stats || {});
                  } catch (e) {
                      console.error(`Không thể phân tích stats cho câu hỏi ID ${q.id}:`, q.stats);
                  }

                  return { id: q.id, text: q.question, options, stats, dateAdded: q.dateAdded, originalTopicId: q.originalTopicId };
              });
              
              return { topics: rawData.topics, sponsors, allQuestions };
          } catch (error) {
              console.warn(`Không thể tải dữ liệu ban đầu. Sử dụng dữ liệu dự phòng. Lỗi:`, error);
              return {
                  topics: MY_LIST,
                  sponsors: MY_INFO,
                  allQuestions: MOCK_ALL_QUESTIONS
              };
          }
      }
      async function submitAnswer(topicId, questionId, selectedOption) {
        const params = { topicId, questionId, selectedOption };
        try {
          await fetchFromApi('submit', params);
          console.log(`Đã gửi thành công câu trả lời cho ${questionId}: ${selectedOption}`);
        } catch (error) {
          console.error('Lỗi mạng khi gửi câu trả lời:', error);
        }
      }
     
      // --- ICONS ---
      const ShuffleIcon = ({ className = 'w-6 h-6' }) => html`<svg xmlns="http://www.w3.org/2000/svg" class=${className} fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6m13-14v4m-4-4l4 4m-4 11v4m-4-4l4 4" /></svg>`;
      const ShareIcon = ({ className = 'w-6 h-6' }) => html`<svg xmlns="http://www.w3.org/2000/svg" class=${className} fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6.002l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.367a3 3 0 105.367 2.684 3 3 0 00-5.367 2.684z" /></svg>`;
      const TrophyIcon = ({ className = 'w-6 h-6' }) => html`<svg xmlns="http://www.w3.org/2000/svg" class=${className} viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>`;
      const CheckCircleIcon = ({ className = 'w-6 h-6' }) => html`<svg xmlns="http://www.w3.org/2000/svg" class=${className} viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;
      const TrashIcon = ({ className = 'w-6 h-6' }) => html`<svg xmlns="http://www.w3.org/2000/svg" class=${className} viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>`;
      const ChevronDownIcon = ({ className = 'w-6 h-6' }) => html`<svg xmlns="http://www.w3.org/2000/svg" class=${className} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>`;

      // --- COMPONENTS ---
      const SponsorBanner = ({ sponsors }) => {
          const activeSponsor = sponsors.find(s => s.isActive);
          if (!activeSponsor) return null;
          const { name, logoUrl, websiteUrl, content } = activeSponsor;
          const safeLogoUrl = convertGoogleDriveUrl(logoUrl);
          const safeWebsiteUrl = normalizeUrl(websiteUrl);

          return html`
              <div class="bg-[#1e1b4b]/60 backdrop-blur-sm rounded-lg p-5 mt-8 animate-fade-in ring-1 ring-white/10">
                  <h3 class="text-sm font-semibold text-gray-400 mb-4 tracking-wider text-center uppercase">Thông điệp từ nhà tài trợ</h3>
                  <p class="text-base text-gray-200 text-justify mb-4">${content}</p>
                  
                  ${websiteUrl && websiteUrl !== '#' && html`
                      <a href=${safeWebsiteUrl} target="_blank" rel="noopener noreferrer" class="text-base text-cyan-400 hover:text-cyan-300 transition-colors duration-200 mt-2 text-left block font-bold">
                          Kết nối ngay →
                      </a>
                  `}
                  
                  <div class="border-t border-white/10 my-4"></div>

                  <div class="text-xs text-gray-500 text-center">Được tài trợ bởi</div>
                  <div class="flex items-center justify-center space-x-2 mt-2">
                      <img src=${safeLogoUrl} alt=${`Logo ${name}`} class="w-5 h-5 rounded-full object-cover" />
                      <span class="text-xs text-gray-400 font-medium">${name}</span>
                  </div>
              </div>
          `;
      };

      const HomePageSponsorFooter = ({ sponsors }) => {
        const activeSponsor = sponsors.find(s => s.isActive);
        if (!activeSponsor) return null;
        const { name, logoUrl, websiteUrl } = activeSponsor;
        const safeLogoUrl = convertGoogleDriveUrl(logoUrl);
        const safeWebsiteUrl = normalizeUrl(websiteUrl);

        return html`
            <div class="text-center mt-12 animate-fade-in">
                <p class="text-xs text-gray-500 mb-2">Được tài trợ bởi</p>
                <a href=${safeWebsiteUrl} target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-3 text-gray-400 hover:text-white transition-colors">
                    <img src=${safeLogoUrl} alt=${`Logo ${name}`} class="w-6 h-6 rounded-full object-cover ring-1 ring-white/10" />
                    <span class="font-semibold">${name}</span>
                </a>
            </div>
        `;
      };

      const ResultsCard = ({ question, selectedOption, onNext, onShare }) => {
          const totalVotes = Object.values(question.stats).reduce((sum, count) => (sum || 0) + (count || 0), 0);
          const selectedOptionVotes = question.stats[selectedOption] || 0;
          const percentage = totalVotes > 0 ? Math.round((selectedOptionVotes / totalVotes) * 100) : 0;

          return html`
              <div class="bg-[#1e1b4b]/60 backdrop-blur-sm rounded-lg p-6 w-full animate-fade-in ring-1 ring-white/10">
                  <h2 class="text-lg font-bold text-white mb-2">${question.text}</h2>
                  <p class="text-gray-400 mb-6">Bạn đã chọn: <span class="font-semibold text-cyan-400">${selectedOption}</span></p>

                  <div class="bg-gray-700/50 rounded-lg p-4 mb-6">
                      <div class="flex justify-between items-center mb-2">
                          <span class="font-bold text-4xl text-cyan-300">${percentage}%</span>
                          <span class="text-gray-300">người đã chọn giống bạn</span>
                      </div>
                      <div class="w-full bg-gray-600 rounded-full h-2.5">
                          <div class="bg-cyan-400 h-2.5 rounded-full" style=${{ width: `${percentage}%` }}></div>
                      </div>
                      <p class="text-xs text-gray-400 mt-2 text-right">${selectedOptionVotes.toLocaleString('vi-VN')} / ${totalVotes.toLocaleString('vi-VN')} lượt vote</p>
                  </div>
                  
                  <div class="space-y-4">
                      ${question.options.map(option => {
                          const votes = question.stats[option] || 0;
                          const optionPercentage = totalVotes > 0 ? Math.round((votes / totalVotes) * 100) : 0;
                          const isSelected = option === selectedOption;
                          return html`
                              <div key=${option} class="relative overflow-hidden rounded-md p-3 ${isSelected ? 'bg-cyan-900/50 ring-2 ring-cyan-400' : 'bg-gray-700/50'}">
                                  <div class="absolute top-0 left-0 h-full ${isSelected ? 'bg-cyan-500/30' : 'bg-gray-500/30'}" style=${{ width: `${optionPercentage}%` }}></div>
                                  <div class="relative flex justify-between items-center z-10">
                                      <span class="font-medium ${isSelected ? 'text-white' : 'text-gray-300'}">${option}</span>
                                      <span class="font-semibold ${isSelected ? 'text-cyan-300' : 'text-gray-400'}">${optionPercentage}%</span>
                                  </div>
                              </div>
                          `;
                      })}
                  </div>
                  
                  <div class="mt-8 flex gap-4">
                      <button onClick=${onShare} class="w-1/3 bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center transition-colors duration-200" aria-label="Chia sẻ kết quả">
                          <${ShareIcon} className="w-5 h-5" />
                      </button>
                      <button onClick=${onNext} class="w-2/3 bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200">
                          Câu hỏi tiếp theo
                      </button>
                  </div>
              </div>
          `;
      };

      const QuestionCard = ({ question, onAnswer, questionNumber, totalQuestions }) => {
          return html`
              <div class="bg-[#1e1b4b]/60 backdrop-blur-sm rounded-lg p-6 w-full animate-fade-in ring-1 ring-white/10">
                  <div class="text-right text-gray-400 text-sm mb-4">Câu ${questionNumber} / ${totalQuestions}</div>
                  <h2 class="text-xl font-bold text-white mb-8 text-center">${question.text}</h2>
                  <div class="space-y-4">
                      ${question.options.map(option => html`
                          <button 
                              key=${option}
                              onClick=${() => onAnswer(option)}
                              class="w-full text-center bg-gradient-to-br from-cyan-400 to-blue-500 hover:from-cyan-500 hover:to-blue-600 text-white font-bold py-3 px-5 rounded-full transition-all duration-200 shadow-lg border border-cyan-400/20 transform hover:scale-105"
                          >
                              ${option}
                          </button>
                      `)}
                  </div>
              </div>
          `;
      };

      const SummaryItem = ({ label, answer }) => {
          if (!answer) return null;
          const { selectedOption, percentage, questionText } = answer;
          return html`
              <div class="bg-gray-700/50 rounded-lg p-4 ring-1 ring-white/10">
                  <p class="text-xs text-cyan-400 font-semibold tracking-wider uppercase">${label}</p>
                  <p class="text-sm text-gray-300 mt-2 italic">Với câu hỏi: "${questionText}"</p>
                  <p class="text-lg font-bold text-white mt-1">Bạn đã chọn: <span class="text-cyan-300">${selectedOption}</span></p>
                  <div class="mt-3">
                      <div class="flex justify-between items-center mb-1">
                          <span class="text-sm font-medium text-gray-300">Độ phổ biến</span>
                          <span class="font-semibold text-cyan-300">${percentage}%</span>
                      </div>
                      <div class="w-full bg-gray-600 rounded-full h-2">
                          <div class="bg-cyan-400 h-2 rounded-full" style=${{ width: `${percentage}%` }}></div>
                      </div>
                  </div>
              </div>
          `;
      };

      const GameSummaryCard = ({ topicName, userAnswers, onPlayAgain }) => {
          const [isCopied, setIsCopied] = useState(false);
          
          if (!userAnswers || userAnswers.length === 0) {
              return html`
                <div class="bg-[#1e1b4b]/60 backdrop-blur-sm rounded-lg p-8 w-full text-center animate-fade-in ring-1 ring-white/10">
                    <h2 class="text-3xl font-bold text-white mb-2">Chủ đề hoàn thành!</h2>
                    <p class="text-gray-300 mb-2">Bạn đã hoàn thành chủ đề <span class="font-semibold text-cyan-400">${topicName}</span>.</p>
                    <p class="text-gray-400 mb-10">Hãy thử một chủ đề khác để khám phá thêm nhé!</p>
                    <button onClick=${onPlayAgain} class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-5 rounded-lg">
                        Quay về trang chủ
                    </button>
                </div>
              `;
          }

          const mostCommonAnswer = userAnswers.reduce((max, current) => (current.percentage > max.percentage) ? current : max, userAnswers[0]);
          const mostUniqueAnswer = userAnswers.reduce((min, current) => (current.percentage < min.percentage) ? current : min, userAnswers[0]);
          
          const handleShare = async () => {
              const shareText = `Tôi đã hoàn thành chủ đề "${topicName}" trong trò chơi "Có Bao Nhiêu Người Giống Bạn?". Câu trả lời tương đồng nhất của tôi giống ${mostCommonAnswer.percentage}% người khác! Bạn hãy thử xem sao nhé!`;
              const shareUrl = window.location.href; 
              
              try {
                  if (navigator.share) {
                      await navigator.share({
                          title: 'Có Bao Nhiêu Người Giống Bạn?',
                          text: shareText,
                          url: shareUrl,
                      });
                  } else {
                      await navigator.clipboard.writeText(`${shareText} ${shareUrl}`);
                      setIsCopied(true);
                      setTimeout(() => setIsCopied(false), 2500);
                  }
              } catch (err) {
                  // Bỏ qua lỗi nếu người dùng hủy hộp thoại chia sẻ
                  if (err.name !== 'AbortError') {
                      console.error('Lỗi khi chia sẻ:', err);
                      alert('Không thể chia sẻ vào lúc này.');
                  }
              }
          };
          
          return html`
              <div class="bg-[#1e1b4b]/60 backdrop-blur-sm rounded-lg p-6 w-full text-center animate-fade-in ring-1 ring-white/10">
                  <div class="flex flex-col items-center gap-4 mb-6">
                      <${TrophyIcon} className="w-16 h-16 text-cyan-300" />
                      <h2 class="text-3xl font-extrabold text-white">Bạn đã hoàn thành!</h2>
                  </div>
                  <p class="text-cyan-200/90 mb-8">
                      Bạn đã trả lời ${userAnswers.length} câu hỏi trong chủ đề <span class="font-bold">${topicName}</span>. Dưới đây là tổng kết hành trình của bạn:
                  </p>
                  <div class="space-y-4 text-left mb-8">
                      ${mostCommonAnswer && html`
                          <${SummaryItem} label="Câu trả lời phổ biến nhất" answer=${mostCommonAnswer} />
                      `}
                      ${mostUniqueAnswer && mostUniqueAnswer !== mostCommonAnswer && html`
                          <${SummaryItem} label="Câu trả lời độc đáo nhất" answer=${mostUniqueAnswer} />
                      `}
                  </div>
                  <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                      <button 
                          onClick=${handleShare} 
                          class="inline-flex items-center justify-center gap-2 w-full sm:w-auto bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-5 rounded-lg transition-colors duration-200 disabled:opacity-50"
                          disabled=${isCopied}
                      >
                          <${ShareIcon} class="w-5 h-5" />
                          ${isCopied ? 'Đã sao chép link!' : 'Mời người khác tham gia'}
                      </button>
                      <button onClick=${onPlayAgain} class="w-full sm:w-auto bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-5 rounded-lg transition-colors duration-200">
                          Chơi lại
                      </button>
                  </div>
              </div>
          `;
      };

      const TopicSelection = ({ topics, onSelectTopic, allQuestions, onResetProgress }) => {
          const [answeredQuestions, setAnsweredQuestions] = useState(getAnsweredQuestions());
          const [showCompleted, setShowCompleted] = useState(false);
          const answeredIds = answeredQuestions.map(a => a.qId);

          const topicProgress = topics.map(topic => {
              const topicQuestions = allQuestions.filter(q => q.originalTopicId === topic.id);
              const answeredInTopic = topicQuestions.filter(q => answeredIds.includes(q.id));
              const isCompleted = topicQuestions.length > 0 && topicQuestions.length === answeredInTopic.length;
              return { ...topic, isCompleted, totalQuestions: topicQuestions.length, answeredCount: answeredInTopic.length };
          });

          const uncompletedTopics = topicProgress.filter(t => !t.isCompleted);
          const completedTopics = topicProgress.filter(t => t.isCompleted);

          const handleReset = () => {
            if (window.confirm('Bạn có chắc muốn xóa toàn bộ tiến trình đã lưu và bắt đầu lại không?')) {
              onResetProgress();
              setAnsweredQuestions([]);
            }
          };

          return html`
              <div class="p-4 md:p-6 w-full animate-fade-in">
                  <header class="text-center mb-8">
                      <h1 class="text-4xl font-extrabold text-white">Có Bao Nhiêu Người</h1>
                      <h1 class="text-4xl font-extrabold text-cyan-400 mb-2">Giống Bạn?</h1>
                      <p class="text-gray-400">Bạn đang ở nhóm nào?</p>
                  </header>
                  
                  <div class="bg-[#1e1b4b]/60 backdrop-blur-sm rounded-lg p-6 mb-6 ring-1 ring-white/10">
                      <h2 class="text-xl font-bold text-white mb-4">Chọn chế độ chơi</h2>
                      <div 
                          class="flex items-center space-x-4 p-4 rounded-lg cursor-pointer transition-all duration-200 bg-gray-700/50 hover:bg-cyan-900/50 hover:ring-2 hover:ring-cyan-500"
                          onClick=${() => onSelectTopic('random')}
                      >
                          <div class="bg-cyan-500 p-3 rounded-lg">
                              <${ShuffleIcon} className="w-6 h-6 text-white" />
                          </div>
                          <div>
                              <h3 class="font-bold text-white">Ngẫu nhiên</h3>
                              <p class="text-sm text-gray-300">6 câu hỏi được trộn từ tất cả các chủ đề.</p>
                          </div>
                      </div>
                  </div>

                  <div class="bg-[#1e1b4b]/60 backdrop-blur-sm rounded-lg p-6 ring-1 ring-white/10">
                      <h2 class="text-xl font-bold text-white mb-4">Hoặc chọn một chủ đề</h2>
                      <div class="space-y-3">
                          ${uncompletedTopics.map(topic => html`
                              <div 
                                  key=${topic.id}
                                  class="p-4 rounded-lg cursor-pointer transition-all duration-200 bg-gray-700/50 hover:bg-gray-700"
                                  onClick=${() => onSelectTopic(topic.id)}
                              >
                                  <div class="flex justify-between items-center">
                                    <h3 class="font-bold text-cyan-400">${topic.name}</h3>
                                    ${topic.answeredCount > 0 && html`
                                      <span class="text-xs font-medium text-gray-400 bg-gray-600 px-2 py-1 rounded-full">${topic.answeredCount}/${topic.totalQuestions}</span>
                                    `}
                                  </div>
                                  <p class="text-sm text-gray-300 mt-1">${topic.description}</p>
                              </div>
                          `)}
                      </div>
                      ${completedTopics.length > 0 && html`
                          <div class="mt-6">
                              <button 
                                  class="w-full flex justify-between items-center p-3 rounded-md text-left text-gray-300 hover:bg-gray-700/50"
                                  onClick=${() => setShowCompleted(!showCompleted)}
                                  aria-expanded=${showCompleted}
                              >
                                  <span class="font-semibold">Chủ đề đã hoàn thành (${completedTopics.length})</span>
                                  <${ChevronDownIcon} className=${`w-5 h-5 transition-transform duration-300 ${showCompleted ? 'rotate-180' : ''}`} />
                              </button>
                              ${showCompleted && html`
                                  <div class="mt-2 space-y-2 animate-slide-down">
                                      ${completedTopics.map(topic => html`
                                          <div key=${topic.id} class="flex items-center space-x-3 p-3 rounded-md bg-gray-700/40">
                                              <${CheckCircleIcon} className="w-5 h-5 text-green-400 flex-shrink-0" />
                                              <span class="text-gray-400">${topic.name}</span>
                                          </div>
                                      `)}
                                  </div>
                              `}
                          </div>
                      `}
                  </div>
                  ${answeredIds.length > 0 && html`
                    <div class="text-center mt-8">
                      <button onClick=${handleReset} class="text-gray-500 hover:text-gray-300 text-sm flex items-center gap-2 mx-auto transition-colors">
                        <${TrashIcon} className="w-4 h-4"/>
                        Chơi lại từ đầu
                      </button>
                    </div>
                  `}
              </div>
          `;
      };

      // --- MAIN APP ---
      const App = () => {
          const [gameState, setGameState] = useState({
              screen: 'loading', // loading, topicSelection, playing, results, summary
              topics: [],
              sponsors: [],
              allQuestions: [],
              currentTopicId: null,
              currentQuestionIndex: -1,
              questionQueue: [],
              lastAnswer: null,
              summaryData: [],
          });
          const [error, setError] = useState(null);

          useEffect(() => {
              const loadData = async () => {
                  try {
                      const { topics, sponsors, allQuestions } = await getInitialData();
                      setGameState(prev => ({ ...prev, topics, sponsors, allQuestions, screen: 'topicSelection' }));
                  } catch (e) {
                      console.error("Lỗi nghiêm trọng khi tải dữ liệu:", e);
                      setError('Không thể tải dữ liệu trò chơi. Vui lòng thử lại sau.');
                      setGameState(prev => ({ ...prev, screen: 'error' }));
                  }
              };
              loadData();
          }, []);

          const startQuiz = (topicId) => {
              const answeredIds = getAnsweredQuestions().map(a => a.qId);
              let questionsForTopic;

              if (topicId === 'random') {
                  questionsForTopic = gameState.allQuestions.filter(q => !answeredIds.includes(q.id));
                  if (questionsForTopic.length === 0) { // All questions answered, reset random
                      questionsForTopic = gameState.allQuestions;
                  }
                  // Lấy 6 câu hỏi ngẫu nhiên
                  questionsForTopic = shuffleArray(questionsForTopic).slice(0, 6);
              } else {
                  questionsForTopic = gameState.allQuestions.filter(q => q.originalTopicId === topicId);
                  questionsForTopic = questionsForTopic.filter(q => !answeredIds.includes(q.id));
              }

              if (questionsForTopic.length === 0) {
                  alert('Bạn đã hoàn thành tất cả câu hỏi trong chủ đề này!');
                  return;
              }

              setGameState(prev => ({
                  ...prev,
                  screen: 'playing',
                  currentTopicId: topicId,
                  questionQueue: questionsForTopic,
                  currentQuestionIndex: 0,
                  lastAnswer: null,
              }));
          };
          
          const handleAnswer = (selectedOption) => {
              const currentQuestion = gameState.questionQueue[gameState.currentQuestionIndex];
              
              const updatedStats = { ...currentQuestion.stats };
              updatedStats[selectedOption] = (updatedStats[selectedOption] || 0) + 1;
              
              const updatedAllQuestions = gameState.allQuestions.map(q => 
                  q.id === currentQuestion.id ? { ...q, stats: updatedStats } : q
              );
              
              setGameState(prev => ({
                  ...prev,
                  screen: 'results',
                  lastAnswer: selectedOption,
                  allQuestions: updatedAllQuestions,
              }));
              
              addAnsweredQuestion(currentQuestion.id, selectedOption);
              submitAnswer(currentQuestion.originalTopicId, currentQuestion.id, selectedOption);
          };

          const handleNextQuestion = () => {
              const nextIndex = gameState.currentQuestionIndex + 1;
              if (nextIndex < gameState.questionQueue.length) {
                  setGameState(prev => ({
                      ...prev,
                      screen: 'playing',
                      currentQuestionIndex: nextIndex,
                      lastAnswer: null,
                  }));
              } else {
                  // Chuyển sang màn hình tổng kết cho tất cả các chế độ chơi
                  const answered = getAnsweredQuestions();

                  const calculatedSummaryData = gameState.questionQueue.map(q => {
                      const userAnswer = answered.find(a => a.qId === q.id);
                      if (!userAnswer) return null;

                      const totalVotes = Object.values(q.stats).reduce((s, c) => (s || 0) + (c || 0), 0);
                      const answerVotes = q.stats[userAnswer.answer] || 0;
                      const percentage = totalVotes > 0 ? Math.round((answerVotes / totalVotes) * 100) : 0;
                      
                      return {
                          questionText: q.text,
                          selectedOption: userAnswer.answer,
                          percentage: percentage,
                      };
                  }).filter(Boolean);
                  
                  setGameState(prev => ({ ...prev, screen: 'summary', summaryData: calculatedSummaryData }));
              }
          };
          
          const handleShare = async () => {
              const currentQuestion = gameState.questionQueue[gameState.currentQuestionIndex];
              const selectedOption = gameState.lastAnswer;
              const totalVotes = Object.values(currentQuestion.stats).reduce((sum, count) => (sum || 0) + (count || 0), 0);
              const selectedOptionVotes = currentQuestion.stats[selectedOption] || 0;
              const percentage = totalVotes > 0 ? Math.round((selectedOptionVotes / totalVotes) * 100) : 0;

              const shareText = `Tôi đã trả lời "${currentQuestion.text}" và ${percentage}% người cũng nghĩ giống tôi! Bạn thì sao?`;
              const shareUrl = window.location.href; 
              
              try {
                  if (navigator.share) {
                      await navigator.share({
                          title: 'Có Bao Nhiêu Người Giống Bạn?',
                          text: shareText,
                          url: shareUrl,
                      });
                  } else {
                      await navigator.clipboard.writeText(`${shareText} ${shareUrl}`);
                      alert('Đã sao chép kết quả vào clipboard!');
                  }
              } catch (err) {
                  // Bỏ qua lỗi nếu người dùng hủy hộp thoại chia sẻ
                  if (err.name !== 'AbortError') {
                      console.error('Lỗi khi chia sẻ:', err);
                      alert('Không thể chia sẻ vào lúc này.');
                  }
              }
          };
          
          const resetToTopics = () => {
              setGameState(prev => ({
                  ...prev,
                  screen: 'topicSelection',
                  currentTopicId: null,
                  currentQuestionIndex: -1,
                  questionQueue: [],
                  lastAnswer: null,
              }));
          };
          
          const handleResetProgress = () => {
              clearAnsweredQuestions();
              // Force a re-render in TopicSelection by passing a new function reference or state update
              setGameState(prev => ({ ...prev })); 
          };

          const renderScreen = () => {
              const { screen, topics, sponsors, allQuestions, questionQueue, currentQuestionIndex, lastAnswer, currentTopicId, summaryData } = gameState;
              
              switch (screen) {
                  case 'loading':
                      return html`<div class="flex justify-center items-center h-screen text-lg text-gray-400">Đang tải trò chơi...</div>`;
                  case 'error':
                       return html`<div class="flex justify-center items-center h-screen text-lg text-red-400 p-8 text-center">${error}</div>`;
                  case 'topicSelection':
                      return html`<${TopicSelection} topics=${topics} allQuestions=${allQuestions} onSelectTopic=${startQuiz} onResetProgress=${handleResetProgress} />`;
                  case 'playing': {
                      const currentQuestion = questionQueue[currentQuestionIndex];
                      return html`<${QuestionCard} 
                                      question=${currentQuestion} 
                                      onAnswer=${handleAnswer}
                                      questionNumber=${currentQuestionIndex + 1}
                                      totalQuestions=${questionQueue.length}
                                  />`;
                  }
                  case 'results': {
                      const currentQuestion = questionQueue[currentQuestionIndex];
                      return html`<${ResultsCard} 
                                      question=${currentQuestion} 
                                      selectedOption=${lastAnswer} 
                                      onNext=${handleNextQuestion} 
                                      onShare=${handleShare}
                                  />`;
                  }
                  case 'summary': {
                      const topicName = currentTopicId === 'random' 
                          ? 'Chủ đề Ngẫu nhiên' 
                          : topics.find(t => t.id === currentTopicId)?.name || 'Chủ đề';

                       return html`<${GameSummaryCard} 
                                       topicName=${topicName} 
                                       userAnswers=${summaryData} 
                                       onPlayAgain=${resetToTopics} 
                                   />`;
                  }
                  default:
                      return html`<div class="text-white">Trạng thái không xác định</div>`;
              }
          };

          const { screen } = gameState;
          const contentMaxWidth = screen === 'topicSelection' ? 'max-w-2xl' : 'max-w-md';

          return html`
            <div class="bg-gradient-to-br from-[#3730a3] to-[#4c1d95] min-h-screen text-gray-200 font-sans">
              <div class="container mx-auto flex flex-col items-center justify-start md:justify-center min-h-screen py-8 px-4">
                  <div class=${`w-full ${contentMaxWidth}`}>
                      <main class="w-full">
                          ${renderScreen()}
                      </main>
                      ${(() => {
                        if (screen === 'topicSelection') {
                          return html`<footer class="w-full"><${HomePageSponsorFooter} sponsors=${gameState.sponsors} /></footer>`;
                        }
                        if (screen === 'playing' || screen === 'results') {
                          return html`<footer class="w-full"><${SponsorBanner} sponsors=${gameState.sponsors} /></footer>`;
                        }
                        // No footer on summary, loading, or error screens
                        return null;
                      })()}
                  </div>
              </div>
            </div>
          `;
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(html`<${React.StrictMode}><${App} /></${React.StrictMode}>`);
    </script>
  </body>
</html>