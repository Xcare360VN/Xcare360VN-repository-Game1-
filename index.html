<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Có Bao Nhiêu Người Giống Bạn?</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "htm": "https://esm.sh/htm@3.1.1"
        }
      }
    </script>
    <style>
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      }
      /* Add a fade-in animation */
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-fade-in {
        animation: fadeIn 0.5s ease-out forwards;
      }
    </style>
  </head>
  <body>
    <div id="root">
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #0c1427; color: #94a3b8; font-size: 1.25rem;">
          Đang tải ứng dụng...
        </div>
    </div>
    <script type="module">
      import React, { useState, useEffect, useCallback, Fragment } from 'react';
      import ReactDOM from 'react-dom/client';
      import htm from 'htm';

      const html = htm.bind(React.createElement);

      // --- HELPERS ---
      const normalizeUrl = (url) => {
        if (typeof url !== 'string' || url.trim() === '' || url.trim() === '#') {
            return '#';
        }
        let trimmedUrl = url.trim();
        if (!/^(https?:\/\/|mailto:|tel:)/i.test(trimmedUrl)) {
            return `https://${trimmedUrl}`;
        }
        return trimmedUrl;
      };
      const convertGoogleDriveUrl = (url) => {
          if (typeof url !== 'string' || !url.includes('drive.google.com')) {
              return url;
          }
          const match = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
          if (match && match[1]) {
              const fileId = match[1];
              return `https://lh3.googleusercontent.com/d/${fileId}`;
          }
          return url;
      };
      const shuffleArray = (array) => {
          return array.map(value => ({ value, sort: Math.random() }))
            .sort((a, b) => a.sort - b.sort)
            .map(({ value }) => value);
      };

      // --- STORAGE SERVICE ---
      const getAnsweredQuestionIds = () => {
        try {
            const storedIds = localStorage.getItem('answeredQuestions');
            return storedIds ? JSON.parse(storedIds) : [];
        } catch (error) {
            console.error('Không thể đọc ID câu hỏi đã trả lời từ localStorage:', error);
            return [];
        }
      };
      const addAnsweredQuestionId = (questionId) => {
          try {
              const answeredIds = getAnsweredQuestionIds();
              if (!answeredIds.includes(questionId)) {
                  answeredIds.push(questionId);
                  localStorage.setItem('answeredQuestions', JSON.stringify(answeredIds));
              }
          } catch (error) {
              console.error('Không thể lưu ID câu hỏi đã trả lời vào localStorage:', error);
          }
      };

      // --- MOCK DATA ---
      const getDaysAgo = (days) => new Date(Date.now() - days * 24 * 60 * 60 * 1000).toISOString();
      const MY_LIST = [
        { id: 'A01PET', name: 'Thú cưng & Động vật', description: 'Khám phá suy nghĩ và cảm xúc của bạn về những người bạn lông lá, có cánh và có vảy của chúng ta. Bạn nghĩ gì về thế giới động vật?' },
        { id: 'B01All', name: 'Trí tuệ nhân tạo', description: 'Hòa mình vào thế giới của AI. Bạn hào hứng hay lo lắng về tương lai của những cỗ máy thông minh? Hãy cùng tìm hiểu xem những người khác nghĩ gì.' }
      ];
      const MY_INFO = [
        { name: 'Công ty Công nghệ Tuyệt vời', logoUrl: 'https://picsum.photos/seed/tech/100/100', websiteUrl: '#', isActive: true, content: 'Chúng tôi tự hào đồng hành cùng bạn trong hành trình khám phá bản thân. Công nghệ là để kết nối, và chúng tôi tin rằng việc hiểu rõ hơn về chính mình và cộng đồng là bước đầu tiên.' },
        { name: 'Thiên đường Thú cưng', logoUrl: 'https://picsum.photos/seed/pet/100/100', websiteUrl: '#', isActive: false, content: 'Mỗi thú cưng là một người bạn. Hãy yêu thương và chăm sóc chúng nhé!' }
      ];
      const A01_PET_QUESTIONS = [
        { id: 'P01', text: 'Bạn có tin rằng chó thực sự là "bạn thân nhất của con người" không?', options: ['Có', 'Không'], stats: JSON.stringify({ 'Có': 1843, 'Không': 211 }), dateAdded: getDaysAgo(30) },
        { id: 'P02', text: 'Bạn thích nuôi mèo hơn nuôi chó?', options: ['Có', 'Không'], stats: JSON.stringify({ 'Có': 987, 'Không': 1067 }), dateAdded: getDaysAgo(25) },
        { id: 'P03', text: 'Có nên nuôi động vật hoang dã làm thú cưng không?', options: ['Có', 'Không'], stats: JSON.stringify({ 'Có': 345, 'Không': 1709 }), dateAdded: getDaysAgo(2) }, // New question
        { id: 'P04', text: 'Bạn sẽ chọn nuôi con vật nào?', options: ['Cá', 'Chim', 'Chuột Hamster', 'Rắn'], stats: JSON.stringify({ 'Cá': 890, 'Chim': 654, 'Chuột Hamster': 432, 'Rắn': 123 }), dateAdded: getDaysAgo(40) }
      ];
      const B01_AI_QUESTIONS = [
        { id: 'AI01', text: 'Bạn có lo lắng một ngày nào đó AI sẽ chiếm lấy công việc của bạn không?', options: ['Có', 'Không'], stats: JSON.stringify({ 'Có': 1302, 'Không': 742 }), dateAdded: getDaysAgo(15) },
        { id: 'AI02', text: 'Bạn có nghĩ rằng AI cuối cùng sẽ trở nên thông minh hơn con người không?', options: ['Có', 'Không'], stats: JSON.stringify({ 'Có': 1655, 'Không': 389 }), dateAdded: getDaysAgo(12) },
        { id: 'AI03', text: 'Bạn có tin tưởng để một AI phẫu thuật cho mình không?', options: ['Có', 'Không'], stats: JSON.stringify({ 'Có': 210, 'Không': 1834 }), dateAdded: getDaysAgo(5) }, // New question
        { id: 'AI04', text: 'Đối với bạn, ứng dụng nào của AI là thú vị nhất?', options: ['Chăm sóc sức khỏe', 'Giao thông vận tải', 'Giải trí', 'Khoa học'], stats: JSON.stringify({ 'Chăm sóc sức khỏe': 788, 'Giao thông vận tải': 450, 'Giải trí': 312, 'Khoa học': 505 }), dateAdded: getDaysAgo(20) }
      ];
      const QUESTION_BANKS = { 'A01PET': A01_PET_QUESTIONS, 'B01All': B01_AI_QUESTIONS };

      // --- GAME SERVICE ---
      const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbykpc4zubNxgaHYtDxkzpt4vmj9wuEKSbPMulbVahByUC_70Pe7st1n5MBAMuBn6_Y9kg/exec';
      async function fetchFromApi(action, params = {}) {
        const urlParams = new URLSearchParams({ action, ...params });
        urlParams.set('v', new Date().getTime().toString());
        const url = `${GOOGLE_SHEET_URL}?${urlParams.toString()}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Server responded with status ${response.status}`);
        const jsonResponse = await response.json();
        const data = jsonResponse.data || jsonResponse;
        if (typeof data === 'object' && data !== null && data.status === 'error' && data.message) {
          throw new Error(`Apps Script error for action '${action}': ${data.message}`);
        }
        return data;
      }
      async function getScriptVersion() {
        try {
          const data = await fetchFromApi('getVersion');
          return data?.version || null;
        } catch (error) {
          console.error(`Không thể lấy phiên bản script:`, error);
          return null;
        }
      }
      function transformQuestion(rawData) {
        const options = [];
        if (rawData.opt1 && rawData.opt1 !== 'N/A') options.push(rawData.opt1);
        if (rawData.opt2 && rawData.opt2 !== 'N/A') options.push(rawData.opt2);
        if (rawData.opt3 && rawData.opt3 !== 'N/A') options.push(rawData.opt3);
        if (rawData.opt4 && rawData.opt4 !== 'N/A') options.push(rawData.opt4);
        let stats = {};
        try {
          stats = JSON.parse(rawData.stats);
        } catch (e) {
          console.error(`Không thể phân tích stats cho câu hỏi ID ${rawData.id}:`, rawData.stats);
        }
        return { id: rawData.id, text: rawData.question, options, stats, dateAdded: rawData.dateAdded };
      }
      async function getTopics() {
        try {
          const data = await fetchFromApi('getTopics');
          if (!Array.isArray(data)) throw new Error("Topic data from sheet is not a valid array.");
          if (data.length > 0 && (data[0].id === undefined || data[0].name === undefined || data[0].description === undefined)) {
            console.error("Invalid topic structure received:", data[0]);
            throw new Error("Topic data has an incorrect structure. Ensure 'id', 'name', and 'description' columns exist in 'Mylist' sheet.");
          }
          return data;
        } catch (error) {
          console.warn(`Không thể tải danh sách chủ đề. Sử dụng dữ liệu dự phòng. Lỗi:`, error);
          return MY_LIST;
        }
      }
      async function getSponsors() {
        try {
          const data = await fetchFromApi('getSponsors');
          if (!Array.isArray(data)) throw new Error("Sponsor data is not a valid array.");
          return data.map(item => ({ ...item, isActive: String(item.isActive).toUpperCase() === 'TRUE' }));
        } catch (error) {
          console.warn(`Không thể tải nhà tài trợ. Sử dụng dữ liệu dự phòng. Lỗi:`, error);
          return MY_INFO;
        }
      }
      async function getQuestionsForTopic(topicId) {
        try {
          const rawData = await fetchFromApi('getQuestions', { topicId });
          if (!Array.isArray(rawData) || rawData.length === 0) throw new Error(`Dữ liệu câu hỏi cho chủ đề ${topicId} không hợp lệ hoặc rỗng.`);
          return rawData.map(transformQuestion);
        } catch (error) {
          console.warn(`Không thể tải câu hỏi cho '${topicId}'. Sử dụng dữ liệu dự phòng. Lỗi:`, error);
          const fallbackBank = QUESTION_BANKS[topicId] || [];
          if (fallbackBank.length === 0) throw new Error(`Không tìm thấy câu hỏi nào (kể cả dự phòng) cho chủ đề '${topicId}'.`);
          return fallbackBank.map(q => ({ ...q, stats: typeof q.stats === 'string' ? JSON.parse(q.stats) : q.stats }));
        }
      }
      async function getAllQuestions(topics) {
        try {
          const questionPromises = topics.map(async (topic) => {
            const questions = await getQuestionsForTopic(topic.id);
            return questions.map(q => ({ ...q, originalTopicId: topic.id }));
          });
          const questionArrays = await Promise.all(questionPromises);
          return questionArrays.flat();
        } catch (error) {
          console.warn(`Không thể tải tất cả câu hỏi. Sử dụng dữ liệu dự phòng. Lỗi:`, error);
          const allMockQuestions = [];
          for (const topicId in QUESTION_BANKS) {
            const questions = QUESTION_BANKS[topicId];
            const augmentedQuestions = questions.map(q => ({ ...q, stats: typeof q.stats === 'string' ? JSON.parse(q.stats) : q.stats, originalTopicId: topicId }));
            allMockQuestions.push(...augmentedQuestions);
          }
          return allMockQuestions;
        }
      }
      async function submitAnswer(topicId, questionId, selectedOption) {
        const params = { topicId, questionId, selectedOption };
        try {
          await fetchFromApi('submit', params);
          console.log(`Đã gửi thành công câu trả lời cho ${questionId}: ${selectedOption}`);
        } catch (error) {
          console.error('Lỗi mạng khi gửi câu trả lời:', error);
        }
      }

      // --- ICONS ---
      const ShuffleIcon = ({ className = 'w-6 h-6' }) => html`<svg xmlns="http://www.w3.org/2000/svg" class=${className} fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6m13-14v4m-4-4l4 4m-4 11v4m-4-4l4 4" /></svg>`;
      const ShareIcon = ({ className = 'w-6 h-6' }) => html`<svg xmlns="http://www.w3.org/2000/svg" class=${className} fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6.002l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.367a3 3 0 105.367 2.684 3 3 0 00-5.367 2.684z" /></svg>`;
      const TrophyIcon = ({ className = 'w-6 h-6' }) => html`<svg xmlns="http://www.w3.org/2000/svg" class=${className} fill="currentColor" viewBox="0 0 16 16"><path d="m8 0l1.669.864 1.858.282.842 1.68 1.337 1.32L13.4 6l.306 1.854-1.337 1.32-.842 1.68-1.858.282L8 12l-1.669-.864-1.858-.282-.842-1.68-1.337-1.32L2.6 6l-.306-1.854 1.337 1.32.842-1.68L6.331.864z"/><path d="M4 11.794V16l4-1 4 1v-4.206l-2.018.306L8 13.126 6.018 12.1z"/></svg>`;
      const PhotoIcon = ({ className = 'w-6 h-6' }) => html`<svg xmlns="http://www.w3.org/2000/svg" class=${className} viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>`;
      const CheckCircleIcon = ({ className = 'w-6 h-6' }) => html`<svg xmlns="http://www.w3.org/2000/svg" class=${className} viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;

      // --- UI COMPONENTS ---
      const Card = ({ children, className = '' }) => html`<div class=${`bg-black/20 backdrop-blur-lg border border-white/20 rounded-2xl shadow-lg p-6 md:p-8 ${className}`}>${children}</div>`;
      const Button = ({ children, variant = 'primary', className = '', ...props }) => {
        const baseClasses = 'font-bold py-3 px-6 rounded-full transition-all duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4';
        const variantClasses = {
          primary: 'bg-cyan-500 hover:bg-cyan-600 text-white shadow-lg focus:ring-cyan-300',
          secondary: 'bg-white/20 hover:bg-white/30 text-white focus:ring-white/50'
        };
        return html`<button class=${`${baseClasses} ${variantClasses[variant]} ${className}`} ...${props}>${children}</button>`;
      };

      // --- COMPONENTS ---
      const DeploymentInstructions = () => html`<div class="mt-4 p-4 bg-red-900/50 border border-red-500/50 rounded-lg text-left text-sm"><h4 class="font-bold text-red-300">Làm thế nào để cập nhật?</h4><p class="mt-2 mb-2 text-red-200/90">Vui lòng làm theo các bước sau trong Google Sheet của bạn:</p><ol class="list-decimal list-inside space-y-1 text-red-200/90"><li>Vào "Tiện ích mở rộng" > "Apps Script".</li><li>Dán mã script mới nhất vào trình soạn thảo.</li><li>Nhấn vào nút "Triển khai" (Deploy) > "Quản lý các bản triển khai" (Manage deployments).</li><li>Tìm bản triển khai đang hoạt động, nhấp vào biểu tượng bút chì ("Chỉnh sửa").</li><li class="font-bold text-white">Trong mục "Phiên bản" (Version), chọn <strong class="bg-white text-red-900 px-1 rounded">"Phiên bản mới" (New version)</strong>.</li><li>Nhấn "Triển khai" (Deploy).</li></ol></div>`;
      const SponsorBanner = ({ sponsor }) => {
        const [logoError, setLogoError] = useState(false);
        useEffect(() => { setLogoError(false); }, [sponsor?.logoUrl]);
        if (!sponsor) return null;
        const logoSrc = convertGoogleDriveUrl(sponsor.logoUrl);
        const websiteHref = normalizeUrl(sponsor.websiteUrl);
        const isClickable = websiteHref !== '#';
        const LinkComponent = isClickable ? 'a' : 'div';
        const linkProps = isClickable ? { href: websiteHref, target: "_blank", rel: "noopener noreferrer" } : {};
        const renderLogo = () => {
          if (!sponsor.logoUrl) return null;
          if (logoError) return html`<div class="w-8 h-8 rounded-full bg-white/10 shrink-0 flex items-center justify-center" title="Không thể tải logo"><${PhotoIcon} className="w-5 h-5 text-white/40" /></div>`;
          return html`<img src=${logoSrc} alt=${`${sponsor.name} logo`} class="w-8 h-8 rounded-full object-cover bg-white/10 shrink-0" onError=${() => setLogoError(true)} />`;
        };
        return html`<div class="text-center py-4 mt-auto"><p class="text-xs text-white/50 mb-2">Được tài trợ bởi</p><${LinkComponent} ...${linkProps} class="inline-flex items-center justify-center gap-3 group">${renderLogo()}<span class="text-sm font-semibold text-white/80 group-hover:text-white transition-colors">${sponsor.name}</span></${LinkComponent}></div>`;
      };
      const SponsorContentCard = ({ sponsor }) => {
        if (!sponsor || !sponsor.content) return null;
        const websiteHref = normalizeUrl(sponsor.websiteUrl);
        const isClickable = websiteHref !== '#';
        return html`<${Card} class="animate-fade-in"><h4 class="text-sm font-bold uppercase tracking-widest text-cyan-300 mb-3 text-center">Thông điệp từ nhà tài trợ</h4><p class="text-center text-cyan-100/80">${sponsor.content}</p>${isClickable && html`<div class="text-center mt-4"><a href=${websiteHref} target="_blank" rel="noopener noreferrer" class="text-cyan-400 hover:text-cyan-300 text-sm font-semibold transition-colors">Ghé thăm ${sponsor.name} →</a></div>`}</${Card}>`;
      };
      const TopicCard = ({ topic, onNewTopic, isLoading }) => {
        return html`<${Card} class="text-center"><h2 class="text-sm font-bold uppercase tracking-widest text-cyan-300 mb-2">${topic?.id === 'random' ? 'Chế độ chơi' : 'Chủ đề trong ngày'}</h2>${isLoading && !topic ? html`<div class="animate-pulse"><div class="h-8 bg-slate-700/50 rounded w-3/4 mx-auto mb-4"></div><div class="h-4 bg-slate-700/50 rounded w-full mx-auto"></div><div class="h-4 bg-slate-700/50 rounded w-5/6 mx-auto mt-2"></div></div>` : topic ? html`<${Fragment}><h1 class="text-3xl md:text-4xl font-extrabold text-white mb-3">${topic.name}</h1><p class="text-cyan-100/80 mb-6">${topic.description}</p></${Fragment}>` : html`<p class="text-cyan-100/80">Chưa có chủ đề nào được chọn.</p>`}<${Button} onClick=${onNewTopic} disabled=${isLoading} variant="secondary" class="inline-flex items-center gap-2"><${ShuffleIcon} class="w-5 h-5" />Chọn chủ đề khác</${Button}></${Card}>`;
      };
      const QuestionCard = ({ question, onAnswer, isLoading }) => {
        if (isLoading) return html`<${Card}><div class="animate-pulse"><div class="h-6 bg-slate-700/50 rounded w-full mb-6"></div><div class="h-6 bg-slate-700/50 rounded w-5/6 mb-8"></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="h-12 bg-slate-700/50 rounded-full"></div><div class="h-12 bg-slate-700/50 rounded-full"></div></div></div></${Card}>`;
        if (!question) return null;
        return html`<${Card}><p class="text-center text-xl md:text-2xl font-medium text-white mb-8">${question.text}</p><div class=${`grid grid-cols-1 ${question.options.length > 2 ? 'md:grid-cols-2' : 'sm:grid-cols-2'} gap-4`}>${question.options.map(option => html`<${Button} key=${option} onClick=${() => onAnswer(option)}>${option}</${Button}>`)}</div></${Card}>`;
      };
      const ResultsCard = ({ question, selectedOption, onNextQuestion, onQuit }) => {
        const [isCopied, setIsCopied] = useState(false);
        if (!question || !question.stats || !question.options) { console.error("ResultsCard nhận được một đối tượng câu hỏi không hợp lệ:", question); return null; }
        const totalVotes = Object.values(question.stats || {}).reduce((sum, count) => sum + Number(count), 0);
        const handleShare = async () => {
          const shareData = { title: 'Có Bao Nhiêu Người Giống Bạn?', text: `Tôi vừa trả lời câu hỏi: "${question.text}". Hãy xem bạn có nghĩ giống tôi không!`, url: window.location.href };
          try {
            if (navigator.share) { await navigator.share(shareData); } else { await navigator.clipboard.writeText(window.location.href); setIsCopied(true); setTimeout(() => setIsCopied(false), 2000); }
          } catch (error) { console.error('Lỗi khi chia sẻ:', error); alert("Không thể chia sẻ. Vui lòng sao chép link từ thanh địa chỉ."); }
        };
        return html`<${Card} class="animate-fade-in"><h3 class="text-2xl font-bold text-center text-white mb-2">Kết quả</h3><p class="text-center text-cyan-200/90 mb-6 italic">"${question.text}"</p><div class="space-y-4 mb-8">${question.options.map(option => {
          const votes = question.stats[option] || 0;
          const percentage = totalVotes > 0 ? ((Number(votes) / totalVotes) * 100).toFixed(0) : '0';
          const isSelected = option === selectedOption;
          return html`<div key=${option} class=${`p-4 rounded-lg border-2 ${isSelected ? 'bg-cyan-500/30 border-cyan-400' : 'bg-white/10 border-transparent'}`}><div class="flex justify-between items-center mb-1 text-white"><span class=${`font-bold ${isSelected ? 'text-cyan-200' : ''}`}>${option} ${isSelected && '(Lựa chọn của bạn)'}</span><span class="font-mono">${percentage}%</span></div><div class="w-full bg-black/20 rounded-full h-3"><div class=${`h-3 rounded-full ${isSelected ? 'bg-cyan-400' : 'bg-white/30'}`} style=${{ width: `${percentage}%` }}></div></div></div>`;
        })}</div><div class="flex flex-col sm:flex-row items-center justify-between gap-4"><${Button} onClick=${handleShare} variant="secondary" class="inline-flex items-center gap-2 w-full sm:w-auto"><${ShareIcon} class="w-5 h-5" />${isCopied ? 'Đã sao chép!' : 'Chia sẻ'}</${Button}><div class="flex flex-col sm:flex-row items-center justify-center gap-4 w-full sm:w-auto"><${Button} onClick=${onQuit} variant="secondary" class="w-full sm:w-auto">Ngừng</${Button}><${Button} onClick=${onNextQuestion} class="w-full sm:w-auto">Câu hỏi tiếp theo →</${Button}></div></div></${Card}>`;
      };
      const GameSummaryCard = ({ userAnswers, onPlayAgain, onShareGame, topicName }) => {
        const [isCopied, setIsCopied] = useState(false);
        const getStats = (answer) => {
          const { question, selectedOption } = answer;
          const totalVotes = Object.values(question.stats || {}).reduce((sum, count) => sum + Number(count), 0);
          const votes = question.stats[selectedOption] || 0;
          const percentage = totalVotes > 0 ? (Number(votes) / totalVotes) * 100 : 0;
          return { ...answer, percentage };
        };
        const answersWithStats = userAnswers.map(getStats);
        const mostCommonAnswer = answersWithStats.reduce((max, current) => (current.percentage > max.percentage) ? current : max, { percentage: -1 });
        const mostUniqueAnswer = answersWithStats.reduce((min, current) => (current.percentage < min.percentage) ? current : min, { percentage: 101 });
        const handleShare = async () => {
          const wasCopied = await onShareGame();
          if (wasCopied) { setIsCopied(true); setTimeout(() => setIsCopied(false), 2000); }
        };
        const SummaryItem = ({ label, answer }) => {
          if (!answer || !answer.question) return null;
          return html`<div class="bg-black/20 p-4 rounded-lg"><p class="text-sm font-bold uppercase tracking-wider text-cyan-300 mb-2">${label}</p><p class="text-cyan-100/80 italic mb-2">"${answer.question.text}"</p><p class="text-white">Bạn đã trả lời <span class="font-bold text-cyan-400">"${answer.selectedOption}"</span>, giống với <span class="font-bold text-cyan-400">${answer.percentage.toFixed(0)}%</span> người khác.</p></div>`;
        };
        return html`<${Card} class="text-center animate-fade-in"><div class="flex flex-col items-center gap-4 mb-6"><${TrophyIcon} className="w-16 h-16 text-cyan-300" /><h2 class="text-3xl font-extrabold text-white">Bạn đã hoàn thành!</h2></div><p class="text-cyan-200/90 mb-8">Bạn đã trả lời ${userAnswers.length} câu hỏi trong chủ đề <span class="font-bold">"${topicName}"</span>. Dưới đây là tổng kết hành trình của bạn:</p><div class="space-y-4 text-left mb-8">${mostCommonAnswer.percentage > -1 && html`<${SummaryItem} label="Câu trả lời phổ biến nhất" answer=${mostCommonAnswer} />`}${mostUniqueAnswer.percentage < 101 && html`<${SummaryItem} label="Câu trả lời độc đáo nhất" answer=${mostUniqueAnswer} />`}</div><div class="flex flex-col sm:flex-row items-center justify-center gap-4"><${Button} onClick=${handleShare} variant="secondary" class="inline-flex items-center gap-2 w-full sm:w-auto"><${ShareIcon} class="w-5 h-5" />${isCopied ? 'Đã sao chép link!' : 'Chia sẻ kết quả'}</${Button}><${Button} onClick=${onPlayAgain} class="w-full sm:w-auto">Chơi lại</${Button}></div></${Card}>`;
      };
      const App = () => {
        const [activeSponsor, setActiveSponsor] = useState(null);
        const [allTopics, setAllTopics] = useState([]);
        const [currentTopic, setCurrentTopic] = useState(null);
        const [questionBank, setQuestionBank] = useState([]);
        const [currentQuestion, setCurrentQuestion] = useState(null);
        const [answeredQuestion, setAnsweredQuestion] = useState(null);
        const [userAnswers, setUserAnswers] = useState([]);
        const [gameState, setGameState] = useState('loading');
        const [error, setError] = useState(null);
        const [diagnosticInfo, setDiagnosticInfo] = useState({ scriptVersion: null, checkComplete: false });
        const RANDOM_TOPIC = { id: 'random', name: 'Ngẫu nhiên', description: 'Các câu hỏi được trộn từ tất cả các chủ đề.' };
        const runDiagnostics = async () => {
          const version = await getScriptVersion();
          setDiagnosticInfo({ scriptVersion: version, checkComplete: true });
        };
        useEffect(() => {
          const loadInitialData = async () => {
            setError(null);
            setDiagnosticInfo({ scriptVersion: null, checkComplete: false });
            setGameState('loading');
            try {
              const topics = await getTopics();
              const [sponsors, allQuestions] = await Promise.all([
                  getSponsors(),
                  getAllQuestions(topics)
              ]);

              const answeredIds = getAnsweredQuestionIds();
              
              const topicsWithCompletion = topics.map(topic => {
                  const questionsForTopic = allQuestions.filter(q => q.originalTopicId === topic.id);
                  if (questionsForTopic.length === 0) {
                      return { ...topic, isCompleted: false };
                  }
                  const isCompleted = questionsForTopic.every(q => answeredIds.includes(q.id));
                  return { ...topic, isCompleted };
              });

              setAllTopics(topicsWithCompletion);
              setActiveSponsor(sponsors.find(s => s.isActive) || null);
              setGameState('selection');
            } catch (e) {
              console.error("Không thể tải dữ liệu ban đầu:", e);
              const errorMessage = e instanceof Error ? e.message : 'Lỗi tải dữ liệu. Vui lòng làm mới trang.';
              setError(errorMessage);
              setGameState('selection');
              if (errorMessage.includes('Hành động không hợp lệ')) { runDiagnostics(); }
            }
          };
          loadInitialData();
        }, []);
        const prepareQuestionBank = (questions, topicName) => {
            const answeredIds = getAnsweredQuestionIds();
            const unansweredQuestions = questions.filter(q => !answeredIds.includes(q.id));

            if (unansweredQuestions.length === 0 && questions.length > 0) {
              throw new Error(`Bạn đã trả lời tất cả các câu hỏi trong chủ đề "${topicName}"! Vui lòng chọn chủ đề khác hoặc xóa dữ liệu trang web trong cài đặt trình duyệt để chơi lại.`);
            }
            if (unansweredQuestions.length === 0) {
                throw new Error(`Chủ đề "${topicName}" hiện chưa có câu hỏi nào.`);
            }

            const SEVEN_DAYS_AGO = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            const newQuestions = [];
            const oldQuestions = [];

            unansweredQuestions.forEach(q => {
              const questionDate = new Date(q.dateAdded);
              if (q.dateAdded && !isNaN(questionDate.getTime()) && questionDate > SEVEN_DAYS_AGO) {
                newQuestions.push(q);
              } else {
                oldQuestions.push(q);
              }
            });

            const shuffledNew = shuffleArray(newQuestions);
            const shuffledOld = shuffleArray(oldQuestions);
            return [...shuffledNew, ...shuffledOld];
        };
        const handleSelectTopic = useCallback(async (topic) => {
          setGameState('loading');
          setError(null);
          try {
            const questions = await getQuestionsForTopic(topic.id);
            const finalQuestionBank = prepareQuestionBank(questions, topic.name);
            setQuestionBank(finalQuestionBank);
            setCurrentQuestion(finalQuestionBank[0]);
            setCurrentTopic(topic);
            setUserAnswers([]);
            setGameState('playing');
          } catch (e) {
            console.error(`Lỗi khi chọn chủ đề ${topic.id}:`, e);
            setError(e instanceof Error ? e.message : 'Không thể tải câu hỏi cho chủ đề này.');
            setGameState('selection');
          }
        }, []);
        const handleSelectRandomMix = useCallback(async () => {
          setGameState('loading');
          setError(null);
          try {
            const questions = await getAllQuestions(allTopics);
            const finalQuestionBank = prepareQuestionBank(questions, RANDOM_TOPIC.name);
            setQuestionBank(finalQuestionBank);
            setCurrentQuestion(finalQuestionBank[0]);
            setCurrentTopic(RANDOM_TOPIC);
            setUserAnswers([]);
            setGameState('playing');
          } catch (e) {
            console.error('Lỗi khi trộn câu hỏi:', e);
            setError(e instanceof Error ? e.message : 'Không thể tải câu hỏi để trộn.');
            setGameState('selection');
          }
        }, [allTopics]);
        const handleNewGame = () => {
          setGameState('selection');
          setError(null);
          setAnsweredQuestion(null);
          setCurrentTopic(null);
          setCurrentQuestion(null);
          setQuestionBank([]);
          setUserAnswers([]);
        };
        const handleNextQuestion = () => {
          setAnsweredQuestion(null);
          const currentIndex = questionBank.findIndex(q => q.id === currentQuestion?.id);
          const nextIndex = currentIndex + 1;
          if (nextIndex < questionBank.length) {
            setCurrentQuestion(questionBank[nextIndex]);
            setGameState('playing');
          } else {
            setGameState('finished');
            setCurrentQuestion(null);
          }
        };
        const handleAnswer = (option) => {
          if (currentQuestion && currentTopic) {
            addAnsweredQuestionId(currentQuestion.id);
            const topicToSubmit = currentQuestion.originalTopicId || currentTopic.id;
            if (topicToSubmit && topicToSubmit !== 'random') {
              submitAnswer(topicToSubmit, currentQuestion.id, option);
            } else {
              console.warn(`Could not determine a valid topic ID to submit for question ${currentQuestion.id}. Submission skipped.`);
            }
            const updatedQuestion = { ...currentQuestion };
            if (!updatedQuestion.stats) updatedQuestion.stats = {};
            updatedQuestion.stats[option] = (Number(updatedQuestion.stats[option]) || 0) + 1;
            const bankIndex = questionBank.findIndex(q => q.id === updatedQuestion.id);
            if (bankIndex > -1) {
              const newBank = [...questionBank];
              newBank[bankIndex] = updatedQuestion;
              setQuestionBank(newBank);
            }
            const answerData = { question: updatedQuestion, selectedOption: option };
            setAnsweredQuestion(answerData);
            setUserAnswers(prev => [...prev, answerData]);
            setCurrentQuestion(updatedQuestion);
            setGameState('results');
          }
        };
        const handleShareGame = async () => {
          const shareData = { title: 'Có Bao Nhiêu Người Giống Bạn?', text: `Hãy chơi thử game này và xem bạn thuộc nhóm người nào nhé!`, url: window.location.href };
          try {
            await navigator.share(shareData);
            return false;
          } catch (error) {
            await navigator.clipboard.writeText(window.location.href);
            return true;
          }
        };
        const renderContent = () => {
          switch (gameState) {
            case 'loading':
              return html`<${Card} class="text-center p-12"><div class="flex justify-center items-center"><div class="w-12 h-12 border-4 border-cyan-400 border-t-transparent rounded-full animate-spin"></div></div><p class="mt-4 text-cyan-200">Đang tải dữ liệu...</p></${Card}>`;
            case 'selection':
              return html`<${Card}><h2 class="text-2xl font-bold text-center mb-6 text-white">Chọn chế độ chơi</h2>${error && html`<div class="mb-4 text-center p-4 bg-red-500/20 border border-red-500/50 rounded-lg"><p class="font-bold text-red-300">Đã xảy ra lỗi</p><p class="text-red-400/90 text-sm mt-1">${error}</p>${diagnosticInfo.checkComplete && html`<div class="mt-3 pt-3 border-t border-red-500/30">${diagnosticInfo.scriptVersion ? html`<p class="text-sm text-yellow-300">Phiên bản script đã triển khai: <span class="font-mono bg-yellow-900/50 px-1 rounded">${diagnosticInfo.scriptVersion}</span></p><p class="text-sm text-yellow-400/80 mt-1">Lỗi này cho thấy phiên bản script của bạn có thể đã lỗi thời.</p>` : html`<p class="text-sm text-yellow-300">Không thể xác định phiên bản script. Rất có thể bạn đang dùng phiên bản cũ chưa được triển khai.</p>`}</div>`}${diagnosticInfo.checkComplete && html`<${DeploymentInstructions} />`}</div>`}<div class="space-y-4"><button onClick=${handleSelectRandomMix} class="w-full text-left p-4 bg-white/10 rounded-lg hover:bg-white/20 transition-colors group"><div class="flex items-center gap-4"><div class="bg-cyan-500 p-3 rounded-md"><${ShuffleIcon} class="w-6 h-6 text-white" /></div><div><h3 class="font-bold text-lg text-white">${RANDOM_TOPIC.name}</h3><p class="text-sm text-cyan-200/80">${RANDOM_TOPIC.description}</p></div></div></button>${allTopics.length > 0 && html`<div class="pt-4"><h3 class="font-semibold text-cyan-200 mb-2">Hoặc chọn một chủ đề</h3><div class="space-y-2">${allTopics.map(topic => html`<button key=${topic.id} onClick=${() => handleSelectTopic(topic)} disabled=${topic.isCompleted} class=${`w-full text-left p-4 rounded-lg transition-all duration-300 ${topic.isCompleted ? 'bg-green-500/10 border border-green-500/20 cursor-not-allowed' : 'bg-black/20 hover:bg-black/30'}`}><div class="flex items-center justify-between"><div><h3 class=${`font-bold text-lg ${topic.isCompleted ? 'text-green-300/70' : 'text-cyan-300'}`}>${topic.name}</h3><p class=${`text-sm ${topic.isCompleted ? 'text-green-200/50' : 'text-cyan-100/80'}`}>${topic.description}</p></div>${topic.isCompleted && html`<div class="flex items-center gap-2 text-green-400 shrink-0 ml-4"><${CheckCircleIcon} className="w-5 h-5" /><span class="text-sm font-semibold">Đã hoàn thành</span></div>`}</div></button>`)}</div></div>`}</div></${Card}>`;
            case 'playing': case 'results': case 'finished':
              return html`<div class="space-y-6"><${TopicCard} topic=${currentTopic} onNewTopic=${handleNewGame} isLoading=${false} />${gameState === 'playing' && html`<${QuestionCard} question=${currentQuestion} onAnswer=${handleAnswer} isLoading=${false} />`}${gameState === 'results' && answeredQuestion && html`<${ResultsCard} question=${answeredQuestion.question} selectedOption=${answeredQuestion.selectedOption} onNextQuestion=${handleNextQuestion} onQuit=${handleNewGame} />`}${gameState === 'finished' && !error && html`<${GameSummaryCard} userAnswers=${userAnswers} onPlayAgain=${handleNewGame} onShareGame=${handleShareGame} topicName=${currentTopic?.name} />`}${gameState === 'finished' && error && html`<${Card}><p class="text-center text-red-400">${error}</p><div class="mt-6 text-center"><${Button} onClick=${handleNewGame}>Thử lại</${Button}></div></${Card}>`}<${SponsorContentCard} sponsor=${activeSponsor} /></div>`;
            default: return null;
          }
        };
        return html`<div class="min-h-screen bg-gradient-to-br from-cyan-900 via-blue-900 to-violet-900 text-white font-sans flex flex-col p-4 md:p-8"><main class="w-full max-w-2xl mx-auto flex-grow"><header class="text-center mb-8 md:mb-12"><h1 class="text-4xl md:text-5xl font-extrabold tracking-tight">Có Bao Nhiêu Người <span class="text-cyan-400">Giống Bạn?</span></h1><p class="text-cyan-200/80 mt-2">Bạn đang ở nhóm nào?</p></header>${renderContent()}</main><${SponsorBanner} sponsor=${activeSponsor} /></div>`;
      };

      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }
      const root = ReactDOM.createRoot(rootElement);
      root.render(html`<${React.StrictMode}><${App} /></${React.StrictMode}>`);
    </script>
  </body>
</html>